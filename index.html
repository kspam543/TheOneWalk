<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>The One Walk - Journey to Mount Doom</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Georgia, serif;
      background: #2d1810;
      color: #f5e6d3;
      overflow: hidden;
      touch-action: none;
    }

    /* Map Container */
    #map-container {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      overflow: hidden;
      background: #1a0f08;
      cursor: grab;
    }
    #map-container.grabbing { cursor: grabbing; }

    /* Wrapper must size to the image and be reference for overlay */
    #map-wrapper {
      position: relative;
      display: inline-block;
      transform-origin: 0 0;
      transition: transform 0.1s ease-out;
    }

    #map-image {
      display: block;
      width: auto;
      height: auto;
      max-width: none;
      user-select: none;
      -webkit-user-drag: none;
    }

    /* SVG Overlay */
    #route-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    #route-overlay circle,
    #route-overlay text {
      pointer-events: auto;
      cursor: pointer;
    }

    /* Route styling */
    .route-base {
      fill: none;
      stroke: #6b4423;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: 0.4;
      stroke-dasharray: 8 4;
    }

    .route-completed {
      fill: none;
      stroke: url(#route-gradient);
      stroke-width: 2.6;
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 6px rgba(220, 38, 38, 0.45));
    }

    /* Waypoint markers */
    .waypoint {
      transition: all 0.2s ease;
      transform-box: fill-box;
      transform-origin: center;
    }

    /* EDIT: remove transform scale hover to avoid SVG jitter */
    .waypoint:hover circle {
      r: 1.35; /* gentle enlarge without transforms */
    }

    .waypoint-reached circle {
      fill: #16a34a;
      stroke: #fef3c7;
    }
    .waypoint-unreached circle {
      fill: #f59e0b;
      stroke: #78350f;
    }
    .waypoint-current circle {
      fill: #dc2626;
      stroke: #fef3c7;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.15); }
    }

    /* Character marker */
    #character-marker {
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.8));
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    /* UI Panel */
    #ui-panel {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: linear-gradient(to top, rgba(29, 24, 16, 0.98), rgba(29, 24, 16, 0.95));
      border-top: 3px solid #92400e;
      max-height: 45vh;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
      transition: transform 0.3s ease;
    }

    #ui-panel.minimized { transform: translateY(calc(100% - 50px)); }

    #panel-handle {
      text-align: center;
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #6b4423;
      font-size: 14px;
      font-weight: bold;
      color: #f59e0b;
      background: rgba(20, 16, 12, 0.5);
    }

    #panel-content { padding: 16px; }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: linear-gradient(135deg, #3d2817, #2d1810);
      border: 2px solid #92400e;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .stat-label {
      font-size: 11px;
      color: #d4a574;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #f5e6d3;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .stat-unit { font-size: 12px; color: #b8956a; }

    /* Progress bar */
    .progress-container {
      background: #2d1810;
      border: 2px solid #6b4423;
      border-radius: 12px;
      height: 24px;
      margin: 16px 0;
      overflow: hidden;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #16a34a, #f59e0b, #dc2626);
      transition: width 0.5s ease;
      box-shadow: 0 0 12px rgba(220, 38, 38, 0.6); /* EDIT: fixed extra ) */
    }

    .progress-text {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      font-weight: bold;
      color: #fef3c7;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
    }

    /* Current location */
    .location-card {
      background: linear-gradient(135deg, #422006, #2d1810);
      border: 2px solid #f59e0b;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .location-name {
      font-size: 18px;
      font-weight: bold;
      color: #fbbf24;
      margin-bottom: 4px;
    }

    .location-desc {
      font-size: 13px;
      color: #d4a574;
      line-height: 1.4;
    }

    /* Log form */
    .log-section {
      background: linear-gradient(135deg, #1e3a5f, #1a2942);
      border: 2px solid #3b82f6;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .log-title {
      font-size: 16px;
      font-weight: bold;
      color: #93c5fd;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input-group { margin-bottom: 12px; }

    .input-label {
      display: block;
      font-size: 12px;
      color: #bfdbfe;
      margin-bottom: 4px;
      font-weight: bold;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: #1e293b;
      border: 2px solid #475569;
      border-radius: 6px;
      color: #f1f5f9;
      font-family: Georgia, serif;
    }

    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .btn {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: Georgia, serif;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .btn-primary:active {
      transform: translateY(2px);
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.4);
    }

    /* Zoom controls */
    .zoom-controls {
      position: fixed;
      bottom: 50vh;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 50;
    }

    .zoom-btn {
      width: 48px;
      height: 48px;
      background: rgba(29, 24, 16, 0.9);
      border: 2px solid #92400e;
      border-radius: 50%;
      color: #f59e0b;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      transition: all 0.2s;
    }

    .zoom-btn:active {
      transform: scale(0.95);
      background: rgba(29, 24, 16, 1);
    }

    /* Waypoint modal */
    #waypoint-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    #waypoint-modal.active { display: flex; }

    .modal-content {
      background: linear-gradient(135deg, #422006, #2d1810);
      border: 3px solid #f59e0b;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7);
    }

    .modal-title {
      font-size: 22px;
      font-weight: bold;
      color: #fbbf24;
      margin-bottom: 8px;
    }

    .modal-distance {
      font-size: 14px;
      color: #d4a574;
      margin-bottom: 16px;
    }

    .modal-lore {
      background: rgba(0, 0, 0, 0.3);
      border-left: 3px solid #f59e0b;
      padding: 12px;
      margin: 12px 0;
      font-size: 13px;
      line-height: 1.6;
      color: #e5d5b7;
      font-style: italic;
    }

    .modal-close {
      margin-top: 16px;
      background: #6b4423;
      color: #f5e6d3;
    }

    /* Celebration overlay */
    #celebration {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 300;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.5s;
    }

    #celebration.active { display: flex; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .celebration-content {
      text-align: center;
      padding: 32px;
      animation: scaleIn 0.5s ease-out;
    }

    @keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .celebration-icon {
      font-size: 80px;
      margin-bottom: 16px;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .celebration-title {
      font-size: 32px;
      font-weight: bold;
      color: #fbbf24;
      margin-bottom: 12px;
      text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }

    .celebration-text {
      font-size: 16px;
      color: #d4a574;
      max-width: 400px;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <!-- Map Container -->
  <div id="map-container">
    <div id="map-wrapper">
      <img id="map-image" src="middle-earth-map.jpg" alt="Middle-earth Map" />
      <svg id="route-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
        <defs>
          <linearGradient id="route-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#16a34a;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#f59e0b;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
          </linearGradient>
        </defs>

        <polyline id="route-base" class="route-base"></polyline>
        <polyline id="route-completed" class="route-completed"></polyline>

        <g id="waypoints"></g>

        <!-- EDIT: smaller character marker -->
        <g id="character-marker">
          <circle r="0.9" fill="#dc2626" stroke="#fef3c7" stroke-width="0.25"></circle>
          <text y="2.2" text-anchor="middle" font-size="2" fill="#fef3c7">üßô‚Äç‚ôÇÔ∏è</text>
        </g>
      </svg>
    </div>
  </div>

  <!-- Zoom Controls -->
  <div class="zoom-controls">
    <button class="zoom-btn" id="zoom-in">+</button>
    <button class="zoom-btn" id="zoom-out">‚àí</button>
    <button class="zoom-btn" id="zoom-reset" style="font-size: 20px;">‚ü≤</button>
  </div>

  <!-- UI Panel -->
  <div id="ui-panel">
    <div id="panel-handle">‚¨ÜÔ∏è Journey Progress ‚¨ÜÔ∏è</div>

    <div id="panel-content">
      <div class="location-card">
        <div class="location-name" id="current-location">Bag End, The Shire</div>
        <div class="location-desc" id="location-desc">Green rolling hills, comfortable and peaceful</div>
      </div>

      <div class="progress-container">
        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        <div class="progress-text" id="progress-text">0% Complete</div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Walked</div>
          <div class="stat-value" id="stat-walked">0<span class="stat-unit">km</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Remaining</div>
          <div class="stat-value" id="stat-remaining">2863<span class="stat-unit">km</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Next Waypoint</div>
          <div class="stat-value" id="stat-next" style="font-size: 18px;">Bucklebury</div>
        </div>
      </div>

      <div class="log-section">
        <div class="log-title">üìù Log Today's Walk</div>

        <div class="input-group">
          <label class="input-label">Distance (km)</label>
          <input type="number" id="distance-input" step="0.1" placeholder="5.0" />
        </div>

        <div class="input-group">
          <label class="input-label">Note (optional)</label>
          <input type="text" id="note-input" placeholder="Morning walk through the park..." />
        </div>

        <button class="btn btn-primary" id="log-btn">‚ûï Add Entry</button>

        <!-- EDIT: Calibration Mode -->
        <div style="margin-top: 12px;">
          <button class="btn" id="calibrate-btn" style="background:#6b4423;color:#f5e6d3;">
            üéØ Calibration Mode: OFF
          </button>
          <div style="font-size:12px;color:#d4a574;margin-top:6px;line-height:1.3;">
            Turn ON, then tap/click the exact waypoint location on the map. It will show x/y % to paste into WAYPOINTS.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Waypoint Modal -->
  <div id="waypoint-modal">
    <div class="modal-content">
      <div class="modal-title" id="modal-title"></div>
      <div class="modal-distance" id="modal-distance"></div>
      <div class="modal-lore" id="modal-lore"></div>
      <button class="btn modal-close" id="modal-close">Close</button>
    </div>
  </div>

  <!-- Celebration -->
  <div id="celebration">
    <div class="celebration-content">
      <div class="celebration-icon">üèÜ</div>
      <div class="celebration-title" id="celebration-title"></div>
      <div class="celebration-text" id="celebration-text"></div>
    </div>
  </div>

<script>
  // Waypoints with coordinates as percentages of map dimensions (0‚Äì100)
  const WAYPOINTS = [
    { id: 1, name: "Bag End, The Shire", distance: 0, x: 35.09, y: 26.91, description: "Green rolling hills, comfortable and peaceful", lore: "Home of Bilbo and Frodo Baggins. Your adventure begins at the round green door of Bag End in Hobbiton." },
    { id: 2, name: "Bucklebury Ferry", distance: 28, x: 20, y: 29, description: "River crossing through gentle farmland", lore: "The hobbits cross the Brandywine River, narrowly escaping the Black Riders pursuing them from the Shire." },
    { id: 3, name: "Bree", distance: 165, x: 26, y: 34, description: "Village at the crossroads", lore: "A village where Men and Hobbits dwell together. Here at The Prancing Pony, Frodo meets the mysterious Strider." },
    { id: 4, name: "Weathertop", distance: 280, x: 32, y: 32, description: "Ancient ruins atop windswept hills", lore: "Ruins of the great watchtower. Here Frodo is wounded by the blade of the Witch-king." },
    { id: 5, name: "Ford of Bruinen", distance: 440, x: 38, y: 29, description: "Swift waters at Rivendell's border", lore: "The enchanted river protecting Rivendell. The Nazg√ªl are swept away by Elrond's flood." },
    { id: 6, name: "Rivendell", distance: 458, x: 50.95, y: 25.88, description: "The Last Homely House", lore: "Imladris, refuge of Elrond. Here the Fellowship is formed and the fate of the Ring is decided." },
    { id: 7, name: "Hollin Gate", distance: 680, x: 45, y: 35, description: "Rocky foothills below Misty Mountains", lore: "The ancient elvish realm of Eregion, where the Rings of Power were forged." },
    { id: 8, name: "Moria", distance: 850, x: 48, y: 38, description: "Dark tunnels through mountain depths", lore: "The greatest of Dwarf-cities, now fallen to shadow. Here Gandalf faces the Balrog." },
    { id: 9, name: "Lothl√≥rien", distance: 1020, x: 53, y: 42, description: "Golden wood of the Galadhrim", lore: "Realm of Galadriel and Celeborn, where time moves differently." },
    { id: 10, name: "Amon Hen", distance: 1260, x: 53, y: 52, description: "Hill of Sight above the great river", lore: "The Seat of Seeing. Here the Fellowship is broken and the Three Hunters begin their chase." },
    { id: 11, name: "Emyn Muil", distance: 1380, x: 56, y: 55, description: "Maze of sharp rocky peaks", lore: "A treacherous labyrinth of stone where Frodo and Sam are lost for days." },
    { id: 12, name: "Dead Marshes", distance: 1540, x: 60, y: 57, description: "Haunted wetlands", lore: "Ancient battlefield where the last alliance fought Sauron. The dead lie preserved in dark waters." },
    { id: 13, name: "Black Gate", distance: 1720, x: 64, y: 58, description: "The great gate of Mordor", lore: "The mighty gateway to Mordor, flanked by the Towers of the Teeth. Too well guarded for passage." },
    { id: 14, name: "Ithilien", distance: 1870, x: 66, y: 63, description: "Fair woodland on Mordor's border", lore: "Once the garden of Gondor. Faramir's rangers ambush Southrons here." },
    { id: 15, name: "Cirith Ungol", distance: 2120, x: 70, y: 68, description: "The high pass guarded by Shelob", lore: "The pass of the spider, where Shelob the Great makes her lair." },
    { id: 16, name: "Tower of Cirith Ungol", distance: 2150, x: 71, y: 69, description: "Evil fortress at the pass", lore: "Orc-tower watching the pass. Frodo is held prisoner here until Sam rescues him." },
    { id: 17, name: "Morgul Vale", distance: 2240, x: 72, y: 72, description: "Valley of evil sorcery", lore: "Minas Morgul glows with corpse-light in this cursed valley." },
    { id: 18, name: "Gorgoroth Plains", distance: 2550, x: 77, y: 78, description: "Ashen wasteland within Mordor", lore: "The desolate plateau of Mordor, filled with orc armies and the smoke of Mount Doom." },
    { id: 19, name: "Mount Doom", distance: 2863, x: 70.49, y: 57.72, description: "The fires where the Ring was forged", lore: "Orodruin, the Mountain of Fire. Here in the Cracks of Doom, the Ring must be unmade." }
  ];

  const TOTAL_DISTANCE = 2863;

  // State
  let entries = [];
  let scale = 1;
  let translateX = 0;
  let translateY = 0;
  let isPanning = false;
  let startX = 0;
  let startY = 0;

  // EDIT: Calibration state
  let calibrationMode = false;

  // DOM Elements
  const mapContainer = document.getElementById('map-container');
  const mapWrapper = document.getElementById('map-wrapper');
  const mapImage = document.getElementById('map-image');
  const routeBase = document.getElementById('route-base');
  const routeCompleted = document.getElementById('route-completed');
  const waypointsGroup = document.getElementById('waypoints');
  const characterMarker = document.getElementById('character-marker');
  const uiPanel = document.getElementById('ui-panel');
  const panelHandle = document.getElementById('panel-handle');

  function init() {
    loadEntries();
    setupZoomControls();
    setupUI();
    setupMap();

    if (mapImage.complete && mapImage.naturalWidth > 0) {
      renderRoute();
      renderWaypoints();
      updateProgress();
      centerMap();
    } else {
      mapImage.onload = () => {
        renderRoute();
        renderWaypoints();
        updateProgress();
        centerMap();
      };
    }
  }

  function loadEntries() {
    const saved = localStorage.getItem('frodoJourneyEntries');
    if (saved) entries = JSON.parse(saved);
  }

  function saveEntries() {
    localStorage.setItem('frodoJourneyEntries', JSON.stringify(entries));
  }

  // EDIT: convert click to percent coords (0‚Äì100) relative to the image
  function getPercentCoordsFromEvent(e) {
    const rect = mapImage.getBoundingClientRect();
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);

    const xPx = (clientX - rect.left) / rect.width;
    const yPx = (clientY - rect.top) / rect.height;

    const x = Math.max(0, Math.min(1, xPx)) * 100;
    const y = Math.max(0, Math.min(1, yPx)) * 100;

    return { x: +x.toFixed(2), y: +y.toFixed(2) };
  }

  function setupMap() {
    // Pan with mouse/touch
    mapContainer.addEventListener('mousedown', startPan);
    mapContainer.addEventListener('touchstart', startPan, { passive: false });
    document.addEventListener('mousemove', pan);
    document.addEventListener('touchmove', pan, { passive: false });
    document.addEventListener('mouseup', endPan);
    document.addEventListener('touchend', endPan);

    // EDIT: calibration click capture
    mapContainer.addEventListener('click', (e) => {
      if (!calibrationMode) return;
      if (e.target.closest('#ui-panel') || e.target.closest('.zoom-controls')) return;

      const { x, y } = getPercentCoordsFromEvent(e);
      alert(`Waypoint coords:\n  x: ${x}\n  y: ${y}\n\nPaste these into the matching WAYPOINT entry.`);
      console.log('Calibration coords:', { x, y });
    });

    // Pinch zoom
    let lastDistance = 0;
    mapContainer.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        lastDistance = Math.sqrt(dx * dx + dy * dy);
      }
    }, { passive: false });

    mapContainer.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const delta = distance - lastDistance;

        if (Math.abs(delta) > 1) {
          zoom(delta > 0 ? 1.05 : 0.95);
          lastDistance = distance;
        }
      }
    }, { passive: false });
  }

  function startPan(e) {
    if (e.target.closest('#ui-panel') || e.target.closest('.zoom-controls')) return;
    if (e.touches && e.touches.length > 1) return;

    isPanning = true;
    mapContainer.classList.add('grabbing');

    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    startX = clientX - translateX;
    startY = clientY - translateY;
  }

  function pan(e) {
    if (!isPanning) return;

    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    translateX = clientX - startX;
    translateY = clientY - startY;

    updateTransform();
  }

  function endPan() {
    isPanning = false;
    mapContainer.classList.remove('grabbing');
  }

  function zoom(factor) {
    const newScale = Math.max(0.5, Math.min(5, scale * factor));
    scale = newScale;
    updateTransform();
  }

  function updateTransform() {
    mapWrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
  }

  function centerMap() {
    const shireWaypoint = WAYPOINTS[0];
    const containerRect = mapContainer.getBoundingClientRect();
    const w = mapImage.naturalWidth || mapImage.width;
    const h = mapImage.naturalHeight || mapImage.height;

    translateX = containerRect.width / 2 - (w * shireWaypoint.x / 100) * scale;
    translateY = containerRect.height / 2 - (h * shireWaypoint.y / 100) * scale;

    updateTransform();
  }

  function setupZoomControls() {
    document.getElementById('zoom-in').addEventListener('click', () => zoom(1.3));
    document.getElementById('zoom-out').addEventListener('click', () => zoom(0.77));
    document.getElementById('zoom-reset').addEventListener('click', () => {
      scale = 1;
      centerMap();
    });
  }

  function setupUI() {
    panelHandle.addEventListener('click', () => {
      uiPanel.classList.toggle('minimized');
    });

    document.getElementById('log-btn').addEventListener('click', addEntry);

    document.getElementById('modal-close').addEventListener('click', () => {
      document.getElementById('waypoint-modal').classList.remove('active');
    });

    document.getElementById('celebration').addEventListener('click', () => {
      document.getElementById('celebration').classList.remove('active');
    });

    // EDIT: calibration toggle
    const calibrateBtn = document.getElementById('calibrate-btn');
    if (calibrateBtn) {
      calibrateBtn.addEventListener('click', () => {
        calibrationMode = !calibrationMode;
        calibrateBtn.textContent = `üéØ Calibration Mode: ${calibrationMode ? 'ON' : 'OFF'}`;
        calibrateBtn.style.border = calibrationMode ? '2px solid #f59e0b' : 'none';
      });
    }
  }

  function renderRoute() {
    const points = WAYPOINTS.map(w => `${w.x},${w.y}`).join(' ');
    routeBase.setAttribute('points', points);
    routeCompleted.setAttribute('points', points);
  }

  function renderWaypoints() {
    waypointsGroup.innerHTML = '';

    const totalWalked = entries.reduce((sum, e) => sum + e.distance, 0);
    const currentWaypointIndex = WAYPOINTS.findIndex(w => w.distance > totalWalked);

    WAYPOINTS.forEach((waypoint, index) => {
      const isReached = totalWalked >= waypoint.distance;
      const isCurrent = index === currentWaypointIndex;

      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.classList.add('waypoint');
      if (isReached) g.classList.add('waypoint-reached');
      else if (isCurrent) g.classList.add('waypoint-current');
      else g.classList.add('waypoint-unreached');

      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', waypoint.x);
      circle.setAttribute('cy', waypoint.y);

      // EDIT: smaller markers
      circle.setAttribute('r', isCurrent ? 0.9 : 0.6);
      circle.setAttribute('stroke-width', isCurrent ? 0.25 : 0.2);

      const innerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      innerCircle.setAttribute('cx', waypoint.x);
      innerCircle.setAttribute('cy', waypoint.y);
      innerCircle.setAttribute('r', 0.22);
      innerCircle.setAttribute('fill', '#fff');
      innerCircle.setAttribute('opacity', '0.8');

      g.appendChild(circle);
      g.appendChild(innerCircle);

      g.addEventListener('click', (e) => {
        e.stopPropagation();
        showWaypointModal(waypoint);
      });

      waypointsGroup.appendChild(g);
    });
  }

  function showWaypointModal(waypoint) {
    document.getElementById('modal-title').textContent = waypoint.name;
    document.getElementById('modal-distance').textContent = `${waypoint.distance} km from The Shire`;
    document.getElementById('modal-lore').textContent = waypoint.lore;
    document.getElementById('waypoint-modal').classList.add('active');
  }

  function updateProgress() {
    const totalWalked = entries.reduce((sum, e) => sum + e.distance, 0);
    const remaining = Math.max(0, TOTAL_DISTANCE - totalWalked);
    const percentComplete = Math.min(100, (totalWalked / TOTAL_DISTANCE) * 100);

    document.getElementById('stat-walked').innerHTML =
      `${totalWalked.toFixed(1)}<span class="stat-unit">km</span>`;
    document.getElementById('stat-remaining').innerHTML =
      `${remaining.toFixed(0)}<span class="stat-unit">km</span>`;

    document.getElementById('progress-bar').style.width = `${percentComplete}%`;
    document.getElementById('progress-text').textContent = `${percentComplete.toFixed(1)}% Complete`;

    const currentWaypointIndex = WAYPOINTS.findIndex(w => w.distance > totalWalked);
    const currentWaypoint = currentWaypointIndex >= 0 ? WAYPOINTS[currentWaypointIndex] : WAYPOINTS[WAYPOINTS.length - 1];
    const previousWaypoint = currentWaypointIndex > 0 ? WAYPOINTS[currentWaypointIndex - 1] : WAYPOINTS[0];

    document.getElementById('current-location').textContent = currentWaypoint.name;
    document.getElementById('location-desc').textContent = currentWaypoint.description;
    document.getElementById('stat-next').textContent = currentWaypoint.name.split(',')[0];

    const totalLength = calculatePathLength();
    const completedLength = totalLength * (percentComplete / 100);
    routeCompleted.style.strokeDasharray = `${completedLength} ${totalLength}`;

    let markerX = previousWaypoint.x;
    let markerY = previousWaypoint.y;

    if (currentWaypointIndex >= 0 && currentWaypointIndex < WAYPOINTS.length) {
      const segmentStart = previousWaypoint.distance;
      const segmentEnd = currentWaypoint.distance;
      const segmentProgress = (totalWalked - segmentStart) / (segmentEnd - segmentStart);

      markerX = previousWaypoint.x + (currentWaypoint.x - previousWaypoint.x) * segmentProgress;
      markerY = previousWaypoint.y + (currentWaypoint.y - previousWaypoint.y) * segmentProgress;
    } else if (totalWalked >= TOTAL_DISTANCE) {
      markerX = WAYPOINTS[WAYPOINTS.length - 1].x;
      markerY = WAYPOINTS[WAYPOINTS.length - 1].y;
    }

    characterMarker.setAttribute('transform', `translate(${markerX}, ${markerY})`);
    renderWaypoints();
  }

  function calculatePathLength() {
    let length = 0;
    for (let i = 1; i < WAYPOINTS.length; i++) {
      const dx = WAYPOINTS[i].x - WAYPOINTS[i - 1].x;
      const dy = WAYPOINTS[i].y - WAYPOINTS[i - 1].y;
      length += Math.sqrt(dx * dx + dy * dy);
    }
    return length;
  }

  function addEntry() {
    const distanceInput = document.getElementById('distance-input');
    const noteInput = document.getElementById('note-input');

    const distance = parseFloat(distanceInput.value);
    if (!distance || distance <= 0) {
      alert('Please enter a valid distance');
      return;
    }

    const previousTotal = entries.reduce((sum, e) => sum + e.distance, 0);

    const newEntry = {
      id: Date.now(),
      date: new Date().toISOString().split('T')[0],
      distance,
      note: noteInput.value.trim()
    };

    entries.push(newEntry);
    saveEntries();

    distanceInput.value = '';
    noteInput.value = '';

    updateProgress();

    const newTotal = entries.reduce((sum, e) => sum + e.distance, 0);
    const passedWaypoint = WAYPOINTS.find(w => w.distance > previousTotal && w.distance <= newTotal);

    if (passedWaypoint) showCelebration(passedWaypoint);

    if (newTotal >= TOTAL_DISTANCE && previousTotal < TOTAL_DISTANCE) {
      setTimeout(() => {
        showCelebration({
          name: "Quest Complete!",
          lore: "You have cast the One Ring into the fires of Mount Doom and saved Middle-earth! The journey of 2,863 km is complete. The Great Eye is vanquished, the Dark Tower falls, and the Age of Men begins."
        });
      }, 1000);
    }
  }

  function showCelebration(waypoint) {
    document.getElementById('celebration-title').textContent = waypoint.name;
    document.getElementById('celebration-text').textContent = waypoint.lore;
    document.getElementById('celebration').classList.add('active');

    setTimeout(() => {
      document.getElementById('celebration').classList.remove('active');
    }, 5000);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

</body>
</html>
