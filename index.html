<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>The One Walk - Journey to Mount Doom</title>

  <style>
    :root{
      /* ========= QUICK SIZING CONTROLS (edit these) ========= */
      --route-base-width: 0.30;        /* base route thickness (SVG units) */
      --route-completed-width: 0.40;   /* completed route thickness */
      --route-base-opacity: 0.35;

      --waypoint-r: 0.45;              /* waypoint radius */
      --waypoint-r-current: 0.65;      /* current waypoint radius */
      --waypoint-stroke: 0.16;         /* waypoint stroke width */
      --waypoint-inner-r: 0.16;

      --marker-ring-r: 0.95;
      --marker-outer-r: 0.55;
      --marker-inner-r: 0.25;
      --marker-emoji-size: 1.3;

      /* Map card height */
      --map-height: 520px;             /* desktop */
      --map-height-mobile: 420px;      /* mobile */
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body{
      font-family: Georgia, serif;
      background: #fff7e6;
      color: #5b3a1e;
      min-height: 100vh;
    }

    /* subtle paper lines */
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:0.18;
      background-image: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(101, 67, 33, 0.05) 2px,
        rgba(101, 67, 33, 0.05) 4px
      );
    }

    .container{
      position:relative;
      z-index:1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px 60px;
    }

    header{
      text-align:center;
      padding-top: 8px;
      margin-bottom: 18px;
    }
    header h1{
      font-size: 44px;
      font-weight: 800;
      color:#6b3f1f;
      letter-spacing: 0.3px;
    }
    header p{
      margin-top: 6px;
      color:#8a5a32;
    }
    header .sub{
      margin-top: 4px;
      font-size: 12px;
      color:#9a6a3a;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:10px;
      justify-content:flex-start;
      flex-wrap:wrap;
      margin: 12px 0 18px;
    }
    .tab-btn{
      display:flex;
      align-items:center;
      gap:8px;
      border:none;
      cursor:pointer;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 14px;
      transition: background 0.15s ease;
      background:#f3d9a6;
      color:#5b3a1e;
      box-shadow: 0 2px 0 rgba(0,0,0,0.05);
    }
    .tab-btn.active{
      background:#8a4f25;
      color:#fff;
    }

    /* Cards */
    .card{
      background: linear-gradient(135deg, #fff3d6, #fffaea);
      border: 2px solid #f1c97a;
      border-radius: 12px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
      padding: 16px;
      margin-bottom: 16px;
    }

    .card h2{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 18px;
      color:#6b3f1f;
      margin-bottom: 12px;
    }

    /* Journey overview */
    .overview-top{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .overview-left{
      flex: 1 1 420px;
      min-width: 260px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#ffe5b5;
      color:#6b3f1f;
      border: 1px solid #f1c97a;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      margin-top: 8px;
      width:fit-content;
    }
    .pill .emoji{ font-size: 18px; }
    .tip{
      font-size: 12px;
      color:#8a5a32;
      margin-top: 6px;
      margin-left: 6px;
    }

    .next-box{
      text-align:right;
      flex: 0 0 auto;
      min-width: 180px;
      padding-top: 2px;
    }
    .next-box .label{
      font-size: 12px;
      color:#8a5a32;
    }
    .next-box .big{
      font-size: 28px;
      font-weight: 800;
      color:#6b3f1f;
    }

    .bar{
      position:relative;
      height: 14px;
      background:#f7dba7;
      border-radius: 999px;
      overflow:hidden;
      margin: 12px 0 12px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #16a34a, #f59e0b, #dc2626);
      transition: width 0.4s ease;
    }

    .overview-metrics{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      text-align:center;
      margin-top: 4px;
    }
    .metric .num{
      font-size: 26px;
      font-weight: 800;
      color:#6b3f1f;
      line-height: 1.1;
    }
    .metric .lbl{
      font-size: 12px;
      color:#8a5a32;
    }

    /* Map card */
    .map-wrap{
      border: 2px solid #cc7a27;
      border-radius: 12px;
      overflow:hidden;
      background: #f5e6d3;
      position:relative;
      height: var(--map-height);
    }
    @media (max-width: 700px){
      header h1{ font-size: 36px; }
      .map-wrap{ height: var(--map-height-mobile); }
      .overview-metrics{ grid-template-columns: 1fr; }
      .next-box{ text-align:left; }
    }

    /* Map viewport (pan/zoom area) */
    #map-viewport{
      position:absolute;
      inset:0;
      overflow:hidden;
      touch-action:none;
      cursor:grab;
    }
    #map-viewport.grabbing{ cursor:grabbing; }

    #map-wrapper{
      position: relative;
      display: inline-block;
      transform-origin: 0 0;
      will-change: transform;
    }

    #map-image{
      display:block;
      width:auto;
      height:auto;
      max-width:none;
      user-select:none;
      -webkit-user-drag:none;
    }

    #route-overlay{
      position:absolute;
      top:0; left:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }

    /* Route */
    .route-base{
      fill:none;
      stroke:#6b4423;
      stroke-width: var(--route-base-width);
      opacity: var(--route-base-opacity);
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 1.2 0.9;
    }
    .route-completed{
      fill:none;
      stroke: url(#route-gradient);
      stroke-width: var(--route-completed-width);
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 3px rgba(220,38,38,0.35));
    }

    /* Waypoints */
    .waypoint { transform-box: fill-box; transform-origin: center; }
    .wp-hit { cursor:pointer; pointer-events:auto; }
    .waypoint:hover .wp-outer { r: calc(var(--waypoint-r) + 0.12); }

    .wp-outer{
      r: var(--waypoint-r);
      stroke-width: var(--waypoint-stroke);
    }
    .wp-inner{ r: var(--waypoint-inner-r); }

    .wp-reached .wp-outer{ fill:#16a34a; stroke:#fff4db; }
    .wp-unreached .wp-outer{ fill:#f59e0b; stroke:#78350f; }
    .wp-current .wp-outer{
      fill:#dc2626; stroke:#fff4db;
      animation: pulse 1.9s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ opacity:1; }
      50%{ opacity:0.75; }
    }

    /* Marker */
    #marker{
      filter: drop-shadow(0 1px 6px rgba(0,0,0,0.35));
    }

    /* Map overlays */
    .map-hint{
      margin-top: 10px;
      font-size: 12px;
      color:#8a5a32;
      text-align:center;
    }

    /* Map controls */
    .map-controls{
      position:absolute;
      right: 12px;
      top: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      z-index: 5;
    }
    .ctrl-btn{
      width:44px;
      height:44px;
      border-radius: 999px;
      border: 2px solid #f1c97a;
      background: rgba(255, 250, 234, 0.95);
      font-size: 20px;
      font-weight: 800;
      cursor:pointer;
      color:#6b3f1f;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    .ctrl-btn:active{ transform: scale(0.98); }

    /* Stats cards (like your screenshot) */
    .grid4{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 900px){
      .grid4{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .statbox{
      border-radius: 10px;
      padding: 12px;
      border: 2px solid rgba(0,0,0,0.06);
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }
    .statbox .t{ font-size: 12px; margin-bottom: 6px; opacity: 0.9; }
    .statbox .v{ font-size: 32px; font-weight: 900; line-height: 1; }
    .statbox .u{ font-size: 12px; margin-top: 4px; opacity:0.85; }

    .g-green{ background: linear-gradient(135deg, #d1fae5, #a7f3d0); color:#064e3b; border-color:#34d399; }
    .g-blue{  background: linear-gradient(135deg, #dbeafe, #bfdbfe); color:#1e3a8a; border-color:#60a5fa; }
    .g-purple{background: linear-gradient(135deg, #ede9fe, #ddd6fe); color:#4c1d95; border-color:#a78bfa; }
    .g-orange{background: linear-gradient(135deg, #ffedd5, #fde68a); color:#7c2d12; border-color:#fb923c; }

    /* Pace analysis block */
    .pace{
      background: linear-gradient(135deg, #fff3d6, #fffbe9);
      border: 2px solid #f1c97a;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
    }
    .pace h3{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 18px;
      margin-bottom: 12px;
      color:#6b3f1f;
    }
    .pace .cols{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }
    @media (max-width: 750px){
      .pace .cols{ grid-template-columns: 1fr; }
    }
    .pace .k{ font-size: 12px; color:#8a5a32; }
    .pace .b{ font-size: 26px; font-weight: 900; color:#6b3f1f; }

    .note{
      margin-top: 12px;
      padding: 12px;
      background:#fff7d0;
      border: 1px solid #f1c97a;
      border-radius: 10px;
      color:#6b3f1f;
      font-size: 13px;
    }

    /* Log cards */
    .blue-card{
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border: 2px solid #93c5fd;
      color:#1e3a8a;
    }
    .purple-card{
      background: linear-gradient(135deg, #f5f3ff, #ede9fe);
      border: 2px solid #c4b5fd;
      color:#4c1d95;
    }

    label{ display:block; font-size: 13px; font-weight: 700; margin-bottom: 6px; }
    input[type="number"], input[type="text"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 2px solid rgba(30,58,138,0.18);
      font-size: 16px;
      font-family: Georgia, serif;
      background:#fff;
      color:#1f2937;
    }

    .btn{
      width:100%;
      padding: 14px;
      border-radius: 12px;
      border:none;
      cursor:pointer;
      font-weight: 900;
      font-size: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: filter 0.12s ease;
    }
    .btn:hover{ filter: brightness(0.98); }
    .btn-blue{ background:#2563eb; color:#fff; }
    .btn-purple{ background:#7c3aed; color:#fff; }
    .btn-green{ background:#16a34a; color:#fff; }
    .btn-red{ background:#dc2626; color:#fff; }

    .actions{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .small{
      font-size: 12px;
      opacity: 0.85;
      margin-top: 10px;
      background: rgba(255,255,255,0.55);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.07);
    }

    /* Recent entries */
    .recent{
      background:#fff;
      border: 2px solid #f1c97a;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.06);
    }
    .recent h2{
      margin-bottom: 10px;
    }
    .entry{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
      background:#fff6dc;
      border: 1px solid #f1c97a;
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 8px;
    }
    .entry .d{ font-weight: 800; color:#6b3f1f; }
    .entry .n{ font-size: 12px; color:#8a5a32; margin-top: 2px; }
    .entry .km{ font-weight: 900; font-size: 18px; color:#6b3f1f; }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 100;
    }
    .modal-backdrop.active{ display:flex; }
    .modal{
      width: min(520px, 100%);
      background: linear-gradient(135deg, #fff7e6, #fffaea);
      border: 3px solid #f1c97a;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.3);
    }
    .modal-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom: 10px;
    }
    .modal h3{
      font-size: 22px;
      color:#6b3f1f;
      font-weight: 900;
    }
    .xbtn{
      border:none;
      cursor:pointer;
      background:#f3d9a6;
      color:#6b3f1f;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 900;
    }
    .modal .k{ font-size: 12px; color:#8a5a32; margin-top: 6px; }
    .modal .v{ font-size: 18px; font-weight: 900; color:#6b3f1f; }
    .lore{
      margin-top: 12px;
      background:#fff1c8;
      border: 1px solid #f1c97a;
      border-radius: 12px;
      padding: 12px;
      font-style: italic;
      color:#6b3f1f;
      line-height: 1.5;
      font-size: 14px;
    }

    /* Calibration button */
    .calib{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .calib button{
      background:#8a4f25;
      color:#fff;
      border:none;
      border-radius: 12px;
      padding: 12px;
      cursor:pointer;
      font-weight: 900;
    }
    .calib .hint{
      font-size: 12px;
      color:#8a5a32;
    }

    /* Hide/Show tabs */
    .tab{ display:none; }
    .tab.active{ display:block; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>The One Walk</h1>
      <p>Track your journey to Mount Doom</p>
      <div class="sub"><span id="totalDistanceLabel"></span> km ‚Ä¢ Based on Tolkien's timeline</div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="journey">üß≠ Journey</button>
      <button class="tab-btn" data-tab="stats">üìä Statistics</button>
      <button class="tab-btn" data-tab="log">‚ûï Log Walk</button>
    </div>

    <!-- JOURNEY TAB -->
    <section class="tab active" id="tab-journey">
      <div class="card" id="journeyOverview">
        <div class="overview-top">
          <div class="overview-left">
            <div style="display:flex; align-items:center; gap:10px;">
              <div style="font-size:22px;">üìç</div>
              <div style="font-weight:900; font-size:18px; color:#6b3f1f;" id="currentWaypointName">‚Äî</div>
            </div>
            <div style="margin-top:4px; font-size:13px; color:#8a5a32;" id="currentWaypointDesc">‚Äî</div>

            <div class="pill" id="terrainPill">
              <span class="emoji">üö∂</span>
              <span style="font-weight:800;">Regular walking</span>
            </div>
            <div class="tip" id="terrainTip">üí° Maintain a steady, comfortable pace</div>
          </div>

          <div class="next-box">
            <div class="label">Next waypoint in</div>
            <div class="big" id="nextKm">‚Äî</div>
            <div style="font-size:12px; color:#8a5a32;">km</div>
          </div>
        </div>

        <div class="bar"><div id="progressFill"></div></div>

        <div class="overview-metrics">
          <div class="metric">
            <div class="num" id="kmWalked">0.0</div>
            <div class="lbl">km walked</div>
          </div>
          <div class="metric">
            <div class="num" id="pctComplete">0.0%</div>
            <div class="lbl">complete</div>
          </div>
          <div class="metric">
            <div class="num" id="kmRemaining">0</div>
            <div class="lbl">km to go</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üìç Interactive Map of Middle-earth</h2>

        <div class="map-wrap">
          <div class="map-controls">
            <button class="ctrl-btn" id="zoomIn">+</button>
            <button class="ctrl-btn" id="zoomOut">‚àí</button>
            <button class="ctrl-btn" id="zoomReset" style="font-size:18px;">‚ü≤</button>
          </div>

          <div id="map-viewport">
            <div id="map-wrapper">
              <img id="map-image" src="middle-earth-map.jpg" alt="Middle-earth Map" />
              <svg id="route-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
                <defs>
                  <linearGradient id="route-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#16a34a;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#f59e0b;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                  </linearGradient>
                </defs>

                <path id="route-base" class="route-base"></path>
                <path id="route-completed" class="route-completed"></path>

                <g id="waypoints"></g>

                <!-- Current position marker -->
                <g id="marker">
                  <circle id="marker-ring" fill="none" stroke="#dc2626" opacity="0.55"></circle>
                  <circle id="marker-outer" fill="#dc2626" stroke="#fff4db"></circle>
                  <circle id="marker-inner" fill="#fff4db"></circle>
                  <text id="marker-emoji" text-anchor="middle" fill="#fff4db">üßô‚Äç‚ôÇÔ∏è</text>
                </g>

                <!-- Compass -->
                <g transform="translate(93, 7)" opacity="0.65">
                  <circle r="3" fill="#fff4db" stroke="#92400e" stroke-width="0.2"></circle>
                  <path d="M 0 -2.5 L 0.4 0 L 0 2.5 L -0.4 0 Z" fill="#dc2626"></path>
                  <path d="M -2.5 0 L 0 -0.4 L 2.5 0 L 0 0.4 Z" fill="#475569"></path>
                  <text y="-3.5" font-size="1.5" fill="#1e293b" text-anchor="middle" font-weight="bold">N</text>
                </g>
              </svg>
            </div>
          </div>
        </div>

        <div class="calib">
          <button id="calibrateBtn">üéØ Calibration Mode: OFF</button>
          <div class="hint">
            Turn ON, then click the exact waypoint location on your map to get x/y percent coordinates to paste into the WAYPOINTS array.
          </div>
        </div>

        <div class="map-hint">Click a waypoint to view details ‚Ä¢ Pan/zoom the map ‚Ä¢ Your coordinates use a 0‚Äì100 overlay grid</div>
      </div>
    </section>

    <!-- STATS TAB -->
    <section class="tab" id="tab-stats">
      <div class="grid4">
        <div class="statbox g-green">
          <div class="t">Current Streak</div>
          <div class="v" id="statCurrentStreak">0</div>
          <div class="u">days</div>
        </div>
        <div class="statbox g-blue">
          <div class="t">Longest Streak</div>
          <div class="v" id="statLongestStreak">0</div>
          <div class="u">days</div>
        </div>
        <div class="statbox g-purple">
          <div class="t">7-Day Average</div>
          <div class="v" id="statAvg7">0.0</div>
          <div class="u">km/day</div>
        </div>
        <div class="statbox g-orange">
          <div class="t">Your Pace vs Frodo</div>
          <div class="v" id="statPaceVs">0%</div>
          <div class="u" id="statPaceVsHint">Start walking</div>
        </div>
      </div>

      <div style="margin-top:16px;" class="pace">
        <h3>üî• Pace Analysis</h3>
        <div class="cols">
          <div>
            <div class="k">Your Daily Pace</div>
            <div class="b" id="statUserPace">0.0 km/day</div>
            <div class="k" id="statDaysSince">Based on 0 days</div>
          </div>
          <div>
            <div class="k">Frodo's Pace (from books)</div>
            <div class="b" id="statFrodoPace">52.1 km/day</div>
            <div class="k">55 days, The Shire to Mount Doom</div>
          </div>
        </div>
        <div class="note" id="paceNote">üéØ Start your first walk to begin comparing your pace to Frodo‚Äôs journey.</div>
      </div>
    </section>

    <!-- LOG TAB -->
    <section class="tab" id="tab-log">
      <div class="card blue-card">
        <h2>üìÖ Log Today's Walk</h2>

        <div style="display:grid; gap:12px;">
          <div>
            <label for="distanceInput">Distance (km)</label>
            <input type="number" id="distanceInput" step="0.1" placeholder="5.0" />
          </div>
          <div>
            <label for="noteInput">Note (optional)</label>
            <input type="text" id="noteInput" placeholder="Morning walk in the park..." />
          </div>

          <button class="btn btn-blue" id="addEntryBtn">‚ûï Add Entry</button>
        </div>
      </div>

      <div class="card purple-card">
        <h2>‚¨ÜÔ∏è Import from Fitness Apps</h2>
        <div style="font-size:13px; margin-bottom:10px;">
          Import walking data from Apple Health, Garmin, Strava, etc. CSV columns: <strong>Date, Distance (km), Note</strong>
        </div>

        <label class="btn btn-purple" style="cursor:pointer;">
          ‚¨ÜÔ∏è Choose CSV File
          <input type="file" id="csvInput" accept=".csv" style="display:none;">
        </label>

        <div class="small">
          <strong>Note:</strong> Your data is saved locally on this device. To sync across devices, export/import the CSV.
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-green" id="exportBtn">‚¨áÔ∏è Export CSV</button>
        <button class="btn btn-red" id="resetBtn">‚ü≤ Reset Journey</button>
      </div>

      <div class="recent" id="recentCard" style="margin-top:16px; display:none;">
        <h2>Recent Walks</h2>
        <div id="recentList"></div>
      </div>
    </section>

  </div>

  <!-- Waypoint modal -->
  <div class="modal-backdrop" id="wpModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-top">
        <h3 id="wpTitle">‚Äî</h3>
        <button class="xbtn" id="wpClose">‚úï</button>
      </div>
      <div class="k">Distance from start</div>
      <div class="v" id="wpDist">‚Äî</div>
      <div class="k" style="margin-top:10px;">Terrain</div>
      <div class="v" id="wpTerrain">‚Äî</div>

      <div class="lore" id="wpLore">‚Äî</div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG + DATA
     ***********************/
    const MAP_IMAGE_SRC = "middle-earth-map.jpg";

    // Frodo timeline
    const TOTAL_DISTANCE = 2863;
    const FRODO_TIMELINE_DAYS = 55;
    const FRODO_DAILY_PACE = TOTAL_DISTANCE / FRODO_TIMELINE_DAYS;

    const TERRAIN_SUGGESTIONS = {
      flat:     { icon: "üö∂", activity: "Regular walking",  tip: "Maintain a steady, comfortable pace" },
      hills:    { icon: "‚õ∞Ô∏è", activity: "Hill training",     tip: "Find local hills or use incline on a treadmill" },
      mountain: { icon: "üèîÔ∏è", activity: "Stair climbing",    tip: "Use stairs, stadium steps, or a StairMaster" },
      valley:   { icon: "üå≤", activity: "Trail walking",     tip: "Walk on uneven terrain or nature trails" },
      marsh:    { icon: "üíß", activity: "Resistance training", tip: "Sand/water walking, or light ankle weights" },
      volcanic: { icon: "üåã", activity: "HIIT intervals",     tip: "Intervals with walking recovery" }
    };

    // Your calibrated WAYPOINTS (keep editing x/y as you calibrate)
    const WAYPOINTS = [
      { id: 1,  name: "Bag End, The Shire",          distance: 0,    segment: 0,   x: 35.09, y: 26.91, terrain:"flat",     description: "Green rolling hills, comfortable and peaceful", lore: "Home of Bilbo and Frodo Baggins. Your adventure begins at the round green door of Bag End in Hobbiton." },
      { id: 2,  name: "Bucklebury Ferry",           distance: 28,   segment: 28,  x: 20.00, y: 29.00, terrain:"flat",     description: "River crossing through gentle farmland", lore: "The hobbits cross the Brandywine River, narrowly escaping the Black Riders pursuing them from the Shire." },
      { id: 3,  name: "Bree",                       distance: 165,  segment: 137, x: 26.00, y: 34.00, terrain:"flat",     description: "Village at the crossroads", lore: "A village where Men and Hobbits dwell together. Here at The Prancing Pony, Frodo meets the mysterious Strider." },
      { id: 4,  name: "Weathertop",                 distance: 280,  segment: 115, x: 32.00, y: 32.00, terrain:"hills",    description: "Ancient ruins atop windswept hills", lore: "Ruins of the great watchtower. Here Frodo is wounded by the blade of the Witch-king." },
      { id: 5,  name: "Ford of Bruinen",            distance: 440,  segment: 160, x: 38.00, y: 29.00, terrain:"hills",    description: "Swift waters at Rivendell's border", lore: "The enchanted river protecting Rivendell. The Nazg√ªl are swept away by Elrond's flood." },
      { id: 6,  name: "Rivendell",                  distance: 458,  segment: 18,  x: 50.95, y: 25.88, terrain:"valley",   description: "The Last Homely House", lore: "Imladris, refuge of Elrond. Here the Fellowship is formed and the fate of the Ring is decided." },
      { id: 7,  name: "Hollin Gate",                distance: 680,  segment: 222, x: 45.00, y: 35.00, terrain:"hills",    description: "Rocky foothills below Misty Mountains", lore: "The ancient elvish realm of Eregion, where the Rings of Power were forged." },
      { id: 8,  name: "Moria",                      distance: 850,  segment: 170, x: 48.00, y: 38.00, terrain:"mountain", description: "Dark tunnels through mountain depths", lore: "The greatest of Dwarf-cities, now fallen to shadow. Here Gandalf faces the Balrog." },
      { id: 9,  name: "Lothl√≥rien",                 distance: 1020, segment: 170, x: 53.00, y: 42.00, terrain:"flat",     description: "Golden wood of the Galadhrim", lore: "Realm of Galadriel and Celeborn, where time moves differently." },
      { id: 10, name: "Amon Hen",                   distance: 1260, segment: 240, x: 53.00, y: 52.00, terrain:"hills",    description: "Hill of Sight above the great river", lore: "The Seat of Seeing. Here the Fellowship is broken and the Three Hunters begin their chase." },
      { id: 11, name: "Emyn Muil",                  distance: 1380, segment: 120, x: 56.00, y: 55.00, terrain:"mountain", description: "Maze of sharp rocky peaks", lore: "A treacherous labyrinth of stone where Frodo and Sam are lost for days." },
      { id: 12, name: "Dead Marshes",               distance: 1540, segment: 160, x: 60.00, y: 57.00, terrain:"marsh",    description: "Haunted wetlands", lore: "Ancient battlefield where the last alliance fought Sauron. The dead lie preserved in dark waters." },
      { id: 13, name: "Black Gate",                 distance: 1720, segment: 180, x: 64.00, y: 58.00, terrain:"flat",     description: "The great gate of Mordor", lore: "The mighty gateway to Mordor. Too well guarded for passage." },
      { id: 14, name: "Ithilien",                   distance: 1870, segment: 150, x: 66.00, y: 63.00, terrain:"hills",    description: "Fair woodland on Mordor's border", lore: "Once the garden of Gondor. Faramir's rangers ambush Southrons here." },
      { id: 15, name: "Cirith Ungol",               distance: 2120, segment: 250, x: 70.00, y: 68.00, terrain:"mountain", description: "The high pass guarded by Shelob", lore: "The pass of the spider, where Shelob the Great makes her lair." },
      { id: 16, name: "Tower of Cirith Ungol",      distance: 2150, segment: 30,  x: 71.00, y: 69.00, terrain:"mountain", description: "Evil fortress at the pass", lore: "Orc-tower watching the pass. Frodo is held prisoner here until Sam rescues him." },
      { id: 17, name: "Morgul Vale",                distance: 2240, segment: 90,  x: 72.00, y: 72.00, terrain:"valley",   description: "Valley of evil sorcery", lore: "Minas Morgul glows with corpse-light in this cursed valley." },
      { id: 18, name: "Gorgoroth Plains",           distance: 2550, segment: 310, x: 77.00, y: 78.00, terrain:"volcanic", description: "Ashen wasteland within Mordor", lore: "The desolate plateau of Mordor, filled with orc armies and the smoke of Mount Doom." },
      { id: 19, name: "Mount Doom",                 distance: 2863, segment: 313, x: 70.49, y: 57.72, terrain:"volcanic", description: "The fires where the Ring was forged", lore: "Orodruin, the Mountain of Fire. Here the Ring must be unmade." }
    ];

    /***********************
     * STATE
     ***********************/
    let entries
    <script>
/* =========================
   CONFIG (easy sizing knobs)
   ========================= */
const CONFIG = {
  TOTAL_DISTANCE: 2863,

  // Route line styling (SVG units in the 0‚Äì100 viewBox space)
  ROUTE_BASE_WIDTH: 0.55,
  ROUTE_COMPLETED_WIDTH: 0.75,
  ROUTE_DASH: "2.4 1.4",

  // Waypoint marker sizing
  WAYPOINT_R: 0.45,
  WAYPOINT_R_CURRENT: 0.65,
  WAYPOINT_STROKE: 0.18,
  WAYPOINT_STROKE_CURRENT: 0.22,
  WAYPOINT_INNER_R: 0.16,

  // ‚ÄúYou are here‚Äù marker sizing
  YOU_RING_R: 1.25,
  YOU_RING_STROKE: 0.18,
  YOU_OUTER_R: 0.65,
  YOU_OUTER_STROKE: 0.18,
  YOU_INNER_R: 0.38,
  YOU_ICON_SIZE: 1.6,
  YOU_LABEL_FONT: 0.8,
  YOU_LABEL_PAD_X: 1.6,
  YOU_LABEL_PAD_Y: 0.9,
  YOU_LABEL_OFFSET_Y: 2.1,

  // Map pan/zoom limits
  MIN_SCALE: 0.5,
  MAX_SCALE: 5,

  // Storage key
  STORAGE_KEY: "frodoJourneyEntries",
};

/* =========================
   WAYPOINTS (0‚Äì100 coords)
   ========================= */
const WAYPOINTS = [
  { id: 1, name: "Bag End, The Shire", distance: 0, x: 35.09, y: 26.91, terrain: "flat", description: "Green rolling hills, comfortable and peaceful", lore: "Home of Bilbo and Frodo Baggins. Your adventure begins at the round green door of Bag End in Hobbiton." },
  { id: 2, name: "Bucklebury Ferry", distance: 28, x: 20, y: 29, terrain: "flat", description: "River crossing through gentle farmland", lore: "The hobbits cross the Brandywine River, narrowly escaping the Black Riders pursuing them from the Shire." },
  { id: 3, name: "Bree", distance: 165, x: 26, y: 34, terrain: "flat", description: "Village at the crossroads", lore: "A village where Men and Hobbits dwell together. Here at The Prancing Pony, Frodo meets the mysterious Strider." },
  { id: 4, name: "Weathertop", distance: 280, x: 32, y: 32, terrain: "hills", description: "Ancient ruins atop windswept hills", lore: "Ruins of the great watchtower. Here Frodo is wounded by the blade of the Witch-king." },
  { id: 5, name: "Ford of Bruinen", distance: 440, x: 38, y: 29, terrain: "hills", description: "Swift waters at Rivendell's border", lore: "The enchanted river protecting Rivendell. The Nazg√ªl are swept away by Elrond's flood." },
  { id: 6, name: "Rivendell", distance: 458, x: 50.95, y: 25.88, terrain: "valley", description: "The Last Homely House", lore: "Imladris, refuge of Elrond. Here the Fellowship is formed and the fate of the Ring is decided." },
  { id: 7, name: "Hollin Gate", distance: 680, x: 45, y: 35, terrain: "hills", description: "Rocky foothills below Misty Mountains", lore: "The ancient elvish realm of Eregion, where the Rings of Power were forged." },
  { id: 8, name: "Moria", distance: 850, x: 48, y: 38, terrain: "mountain", description: "Dark tunnels through mountain depths", lore: "The greatest of Dwarf-cities, now fallen to shadow. Here Gandalf faces the Balrog." },
  { id: 9, name: "Lothl√≥rien", distance: 1020, x: 53, y: 42, terrain: "flat", description: "Golden wood of the Galadhrim", lore: "Realm of Galadriel and Celeborn, where time moves differently." },
  { id: 10, name: "Amon Hen", distance: 1260, x: 53, y: 52, terrain: "hills", description: "Hill of Sight above the great river", lore: "The Seat of Seeing. Here the Fellowship is broken and the Three Hunters begin their chase." },
  { id: 11, name: "Emyn Muil", distance: 1380, x: 56, y: 55, terrain: "mountain", description: "Maze of sharp rocky peaks", lore: "A treacherous labyrinth of stone where Frodo and Sam are lost for days." },
  { id: 12, name: "Dead Marshes", distance: 1540, x: 60, y: 57, terrain: "marsh", description: "Haunted wetlands", lore: "Ancient battlefield where the last alliance fought Sauron. The dead lie preserved in dark waters." },
  { id: 13, name: "Black Gate", distance: 1720, x: 64, y: 58, terrain: "flat", description: "The great gate of Mordor", lore: "The mighty gateway to Mordor, flanked by the Towers of the Teeth. Too well guarded for passage." },
  { id: 14, name: "Ithilien", distance: 1870, x: 66, y: 63, terrain: "hills", description: "Fair woodland on Mordor's border", lore: "Once the garden of Gondor. Faramir's rangers ambush Southrons here." },
  { id: 15, name: "Cirith Ungol", distance: 2120, x: 70, y: 68, terrain: "mountain", description: "The high pass guarded by Shelob", lore: "The pass of the spider, where Shelob the Great makes her lair." },
  { id: 16, name: "Tower of Cirith Ungol", distance: 2150, x: 71, y: 69, terrain: "mountain", description: "Evil fortress at the pass", lore: "Orc-tower watching the pass. Frodo is held prisoner here until Sam rescues him." },
  { id: 17, name: "Morgul Vale", distance: 2240, x: 72, y: 72, terrain: "valley", description: "Valley of evil sorcery", lore: "Minas Morgul glows with corpse-light in this cursed valley." },
  { id: 18, name: "Gorgoroth Plains", distance: 2550, x: 77, y: 78, terrain: "volcanic", description: "Ashen wasteland within Mordor", lore: "The desolate plateau of Mordor, filled with orc armies and the smoke of Mount Doom." },
  { id: 19, name: "Mount Doom", distance: 2863, x: 70.49, y: 57.72, terrain: "volcanic", description: "The fires where the Ring was forged", lore: "Orodruin, the Mountain of Fire. Here in the Cracks of Doom, the Ring must be unmade." }
];

const TERRAIN_SUGGESTIONS = {
  flat: { icon: "üö∂", activity: "Regular walking", tip: "Maintain a steady, comfortable pace" },
  hills: { icon: "‚õ∞Ô∏è", activity: "Hill training", tip: "Use incline or seek gentle hills" },
  mountain: { icon: "üèîÔ∏è", activity: "Stair climbing", tip: "Stairs, step-ups, or StairMaster" },
  valley: { icon: "üå≤", activity: "Trail walking", tip: "Uneven paths or packed gravel trails" },
  marsh: { icon: "üíß", activity: "Resistance training", tip: "Sand walking or light resistance work" },
  volcanic: { icon: "üåã", activity: "Intervals / HIIT", tip: "Short bursts with walking recovery" },
};

const FRODO_TIMELINE_DAYS = 55;
const FRODO_DAILY_PACE = CONFIG.TOTAL_DISTANCE / FRODO_TIMELINE_DAYS;

/* =========================
   * STATE
   ========================= */
let entries = [];
let activeTab = "journey";

let scale = 1;
let translateX = 0;
let translateY = 0;
let isPanning = false;
let startX = 0;
let startY = 0;

let calibrationMode = false;

/* =========================
   DOM HOOKS (expects your HTML IDs)
   ========================= */
const el = {
  // Layout / tabs
  tabJourney: document.getElementById("tab-journey"),
  tabStats: document.getElementById("tab-stats"),
  tabLog: document.getElementById("tab-log"),
  panelJourney: document.getElementById("panel-journey"),
  panelStats: document.getElementById("panel-stats"),
  panelLog: document.getElementById("panel-log"),

  // Map/pan/zoom
  mapContainer: document.getElementById("map-container"),
  mapWrapper: document.getElementById("map-wrapper"),
  mapImage: document.getElementById("map-image"),
  overlay: document.getElementById("route-overlay"),
  routeBase: document.getElementById("route-base"),
  routeCompleted: document.getElementById("route-completed"),
  waypointsGroup: document.getElementById("waypoints"),
  youMarker: document.getElementById("you-marker"),

  zoomIn: document.getElementById("zoom-in"),
  zoomOut: document.getElementById("zoom-out"),
  zoomReset: document.getElementById("zoom-reset"),

  // Journey card
  currentLocation: document.getElementById("current-location"),
  locationDesc: document.getElementById("location-desc"),
  terrainIcon: document.getElementById("terrain-icon"),
  terrainActivity: document.getElementById("terrain-activity"),
  terrainTip: document.getElementById("terrain-tip"),
  nextWaypointKm: document.getElementById("next-waypoint-km"),
  kmWalked: document.getElementById("km-walked"),
  pctComplete: document.getElementById("pct-complete"),
  kmRemaining: document.getElementById("km-remaining"),
  progressBar: document.getElementById("progress-bar"),

  // Log
  distanceInput: document.getElementById("distance-input"),
  noteInput: document.getElementById("note-input"),
  addEntryBtn: document.getElementById("add-entry"),
  exportBtn: document.getElementById("export-csv"),
  resetBtn: document.getElementById("reset-journey"),
  importInput: document.getElementById("import-csv"),

  // Recent entries list (optional)
  recentList: document.getElementById("recent-entries"),

  // Stats
  statCurrentStreak: document.getElementById("stat-current-streak"),
  statLongestStreak: document.getElementById("stat-longest-streak"),
  statAvg7: document.getElementById("stat-avg-7"),
  statPaceVsFrodo: document.getElementById("stat-pace-frodo"),
  statUserPace: document.getElementById("stat-user-pace"),
  statFrodoPace: document.getElementById("stat-frodo-pace"),
  statPaceNote: document.getElementById("stat-pace-note"),

  // Waypoint modal (optional)
  waypointModal: document.getElementById("waypoint-modal"),
  modalTitle: document.getElementById("modal-title"),
  modalDistance: document.getElementById("modal-distance"),
  modalLore: document.getElementById("modal-lore"),
  modalClose: document.getElementById("modal-close"),

  // Calibration toggle (optional)
  calibrateBtn: document.getElementById("calibrate-btn"),
};

/* =========================
   INIT
   ========================= */
function init() {
  loadEntries();
  wireUI();
  wireMap();

  // Ensure SVG defaults match config (route widths/dash)
  if (el.routeBase) {
    el.routeBase.style.strokeWidth = CONFIG.ROUTE_BASE_WIDTH;
    el.routeBase.style.strokeDasharray = CONFIG.ROUTE_DASH;
  }
  if (el.routeCompleted) {
    el.routeCompleted.style.strokeWidth = CONFIG.ROUTE_COMPLETED_WIDTH;
  }

  // Render once image is ready
  if (el.mapImage && el.mapImage.complete && el.mapImage.naturalWidth > 0) {
    renderAll();
    centerOnStart();
  } else if (el.mapImage) {
    el.mapImage.onload = () => {
      renderAll();
      centerOnStart();
    };
  } else {
    // No map image present; still render panels
    renderPanels();
  }
}

function renderAll() {
  renderRoute();
  renderWaypoints();
  updateComputedUI();
  renderPanels();
}

function renderPanels() {
  // Only toggles if you have these containers; safe if not.
  if (el.panelJourney) el.panelJourney.style.display = activeTab === "journey" ? "block" : "none";
  if (el.panelStats) el.panelStats.style.display = activeTab === "stats" ? "block" : "none";
  if (el.panelLog) el.panelLog.style.display = activeTab === "log" ? "block" : "none";

  // Tab button styling if present
  const setActive = (btn, on) => {
    if (!btn) return;
    btn.classList.toggle("active", on);
  };
  setActive(el.tabJourney, activeTab === "journey");
  setActive(el.tabStats, activeTab === "stats");
  setActive(el.tabLog, activeTab === "log");
}

/* =========================
   STORAGE
   ========================= */
function loadEntries() {
  try {
    const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
    entries = saved ? JSON.parse(saved) : [];
    if (!Array.isArray(entries)) entries = [];
  } catch {
    entries = [];
  }
}

function saveEntries() {
  localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(entries));
}

/* =========================
   COMPUTED HELPERS
   ========================= */
function totalWalked() {
  return entries.reduce((sum, e) => sum + (Number(e.distance) || 0), 0);
}

function percentComplete() {
  return Math.min(100, (totalWalked() / CONFIG.TOTAL_DISTANCE) * 100);
}

function remainingKm() {
  return Math.max(0, CONFIG.TOTAL_DISTANCE - totalWalked());
}

function currentWaypointIndex() {
  const tw = totalWalked();
  const idx = WAYPOINTS.findIndex(w => w.distance > tw);
  return idx === -1 ? WAYPOINTS.length - 1 : idx;
}

function getCurrentWaypoint() {
  const idx = currentWaypointIndex();
  return WAYPOINTS[idx] || WAYPOINTS[WAYPOINTS.length - 1];
}

function getPreviousWaypoint() {
  const idx = currentWaypointIndex();
  return idx > 0 ? WAYPOINTS[idx - 1] : WAYPOINTS[0];
}

function getMarkerPosition() {
  const tw = totalWalked();
  const idx = WAYPOINTS.findIndex(w => w.distance > tw);

  const prev = idx > 0 ? WAYPOINTS[idx - 1] : WAYPOINTS[0];

  if (idx >= 0 && idx < WAYPOINTS.length) {
    const cur = WAYPOINTS[idx];
    const segStart = prev.distance;
    const segEnd = cur.distance;
    const t = segEnd === segStart ? 0 : (tw - segStart) / (segEnd - segStart);
    const clamped = Math.max(0, Math.min(1, t));
    return {
      x: prev.x + (cur.x - prev.x) * clamped,
      y: prev.y + (cur.y - prev.y) * clamped
    };
  }

  // Completed
  const last = WAYPOINTS[WAYPOINTS.length - 1];
  return { x: last.x, y: last.y };
}

/* =========================
   ROUTE + WAYPOINT RENDER
   ========================= */
function renderRoute() {
  if (!el.routeBase || !el.routeCompleted) return;
  const points = WAYPOINTS.map(w => `${w.x},${w.y}`).join(" ");
  el.routeBase.setAttribute("points", points);
  el.routeCompleted.setAttribute("points", points);

  // Completed segment via stroke-dasharray
  const totalLen = calculatePolylineLength(WAYPOINTS);
  const doneLen = totalLen * (percentComplete() / 100);
  el.routeCompleted.style.strokeDasharray = `${doneLen} ${totalLen}`;
}

function renderWaypoints() {
  if (!el.waypointsGroup) return;
  el.waypointsGroup.innerHTML = "";

  const tw = totalWalked();
  const idx = WAYPOINTS.findIndex(w => w.distance > tw);

  WAYPOINTS.forEach((w, i) => {
    const reached = tw >= w.distance;
    const current = i === idx;

    const g = svgEl("g", { class: "waypoint" });
    g.dataset.waypointId = String(w.id);

    const r = current ? CONFIG.WAYPOINT_R_CURRENT : CONFIG.WAYPOINT_R;
    const sw = current ? CONFIG.WAYPOINT_STROKE_CURRENT : CONFIG.WAYPOINT_STROKE;

    const main = svgEl("circle", {
      cx: w.x, cy: w.y, r,
      fill: reached ? "#16a34a" : "#f59e0b",
      stroke: current ? "#dc2626" : "#78350f",
      "stroke-width": sw
    });

    const inner = svgEl("circle", {
      cx: w.x, cy: w.y,
      r: CONFIG.WAYPOINT_INNER_R,
      fill: "#fff", opacity: 0.85
    });

    g.appendChild(main);
    g.appendChild(inner);

    // Click -> modal if present
    g.addEventListener("click", (e) => {
      e.stopPropagation();
      openWaypointModal(w);
    });

    el.waypointsGroup.appendChild(g);
  });

  // Update ‚Äúyou are here‚Äù
  renderYouMarker();
}

function renderYouMarker() {
  if (!el.youMarker) return;

  const { x, y } = getMarkerPosition();
  el.youMarker.innerHTML = "";

  // Ring
  el.youMarker.appendChild(svgEl("circle", {
    cx: x, cy: y,
    r: CONFIG.YOU_RING_R,
    fill: "none",
    stroke: "#dc2626",
    "stroke-width": CONFIG.YOU_RING_STROKE,
    opacity: 0.55
  }));

  // Outer
  el.youMarker.appendChild(svgEl("circle", {
    cx: x, cy: y,
    r: CONFIG.YOU_OUTER_R,
    fill: "#dc2626",
    stroke: "#fef3c7",
    "stroke-width": CONFIG.YOU_OUTER_STROKE
  }));

  // Inner
  el.youMarker.appendChild(svgEl("circle", {
    cx: x, cy: y,
    r: CONFIG.YOU_INNER_R,
    fill: "#fef3c7"
  }));

  // Icon
  el.youMarker.appendChild(svgEl("text", {
    x, y: y + (CONFIG.YOU_ICON_SIZE * 1.4),
    "text-anchor": "middle",
    "font-size": CONFIG.YOU_ICON_SIZE
  }, "üßô‚Äç‚ôÇÔ∏è"));

  // Label
  const labelY = y + CONFIG.YOU_LABEL_OFFSET_Y + (CONFIG.YOU_ICON_SIZE * 1.8);
  const text = "YOU ARE HERE";
  const approxTextW = text.length * (CONFIG.YOU_LABEL_FONT * 0.55);
  const boxW = approxTextW + CONFIG.YOU_LABEL_PAD_X;
  const boxH = CONFIG.YOU_LABEL_PAD_Y;

  el.youMarker.appendChild(svgEl("rect", {
    x: x - boxW / 2,
    y: labelY - boxH / 2,
    width: boxW,
    height: boxH,
    rx: 0.25,
    fill: "#1e293b",
    opacity: 0.85
  }));

  el.youMarker.appendChild(svgEl("text", {
    x, y: labelY + (CONFIG.YOU_LABEL_FONT * 0.35),
    "text-anchor": "middle",
    "font-size": CONFIG.YOU_LABEL_FONT,
    fill: "#fef3c7",
    "font-weight": "700"
  }, text));
}

/* =========================
   UI UPDATES (Journey + Stats + Log)
   ========================= */
function updateComputedUI() {
  const tw = totalWalked();
  const pct = percentComplete();
  const rem = remainingKm();

  const cur = getCurrentWaypoint();
  const prev = getPreviousWaypoint();
  const terrain = TERRAIN_SUGGESTIONS[cur.terrain] || TERRAIN_SUGGESTIONS.flat;

  // Journey panel fields
  if (el.currentLocation) el.currentLocation.textContent = cur.name;
  if (el.locationDesc) el.locationDesc.textContent = cur.description;

  if (el.terrainIcon) el.terrainIcon.textContent = terrain.icon;
  if (el.terrainActivity) el.terrainActivity.textContent = terrain.activity;
  if (el.terrainTip) el.terrainTip.textContent = `üí° ${terrain.tip}`;

  if (el.nextWaypointKm) {
    const nextIn = Math.max(0, cur.distance - tw);
    el.nextWaypointKm.textContent = `${nextIn.toFixed(1)} km`;
  }

  if (el.kmWalked) el.kmWalked.textContent = tw.toFixed(1);
  if (el.pctComplete) el.pctComplete.textContent = pct.toFixed(1);
  if (el.kmRemaining) el.kmRemaining.textContent = rem.toFixed(0);

  if (el.progressBar) el.progressBar.style.width = `${pct}%`;

  // Route completed stroke dash
  if (el.routeCompleted) {
    const totalLen = calculatePolylineLength(WAYPOINTS);
    const doneLen = totalLen * (pct / 100);
    el.routeCompleted.style.strokeDasharray = `${doneLen} ${totalLen}`;
  }

  // Stats
  const streakNow = calculateCurrentStreak(entries);
  const streakBest = calculateLongestStreak(entries);
  const avg7 = calculate7DayAverage(entries);

  const pace = calculateUserPace(entries);
  const paceVs = pace > 0 ? Math.round((pace / FRODO_DAILY_PACE) * 100) : 0;

  if (el.statCurrentStreak) el.statCurrentStreak.textContent = String(streakNow);
  if (el.statLongestStreak) el.statLongestStreak.textContent = String(streakBest);
  if (el.statAvg7) el.statAvg7.textContent = avg7.toFixed(1);
  if (el.statPaceVsFrodo) el.statPaceVsFrodo.textContent = String(paceVs);

  if (el.statUserPace) el.statUserPace.textContent = `${pace.toFixed(1)} km/day`;
  if (el.statFrodoPace) el.statFrodoPace.textContent = `${FRODO_DAILY_PACE.toFixed(1)} km/day`;

  if (el.statPaceNote) {
    el.statPaceNote.textContent =
      pace <= 0
        ? "Start your first walk to begin comparing your pace to Frodo‚Äôs journey."
        : pace > FRODO_DAILY_PACE
          ? "You‚Äôre walking faster than Frodo‚Äôs book pace."
          : "You‚Äôre taking a more relaxed pace than Frodo‚Äôs book pace.";
  }

  // Recent entries list (optional)
  renderRecentEntries();
}

function renderRecentEntries() {
  if (!el.recentList) return;
  el.recentList.innerHTML = "";

  const recent = entries.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 15);
  if (recent.length === 0) {
    el.recentList.innerHTML = `<div class="empty">No entries yet.</div>`;
    return;
  }

  recent.forEach(e => {
    const row = document.createElement("div");
    row.className = "recent-row";
    row.innerHTML = `
      <div class="recent-left">
        <div class="recent-date">${escapeHtml(e.date)}</div>
        ${e.note ? `<div class="recent-note">${escapeHtml(e.note)}</div>` : ""}
      </div>
      <div class="recent-km">${Number(e.distance).toFixed(1)} km</div>
    `;
    el.recentList.appendChild(row);
  });
}

/* =========================
   TAB + BUTTON WIRING
   ========================= */
function wireUI() {
  if (el.tabJourney) el.tabJourney.addEventListener("click", () => { activeTab = "journey"; renderPanels(); });
  if (el.tabStats) el.tabStats.addEventListener("click", () => { activeTab = "stats"; renderPanels(); });
  if (el.tabLog) el.tabLog.addEventListener("click", () => { activeTab = "log"; renderPanels(); });

  if (el.addEntryBtn) el.addEntryBtn.addEventListener("click", onAddEntry);
  if (el.exportBtn) el.exportBtn.addEventListener("click", exportCSV);
  if (el.resetBtn) el.resetBtn.addEventListener("click", resetJourney);

  if (el.importInput) el.importInput.addEventListener("change", handleCSVImport);

  if (el.modalClose && el.waypointModal) {
    el.modalClose.addEventListener("click", () => el.waypointModal.classList.remove("active"));
    el.waypointModal.addEventListener("click", (e) => {
      if (e.target === el.waypointModal) el.waypointModal.classList.remove("active");
    });
  }

  if (el.calibrateBtn) {
    el.calibrateBtn.addEventListener("click", () => {
      calibrationMode = !calibrationMode;
      el.calibrateBtn.textContent = `üéØ Calibration Mode: ${calibrationMode ? "ON" : "OFF"}`;
      el.calibrateBtn.classList.toggle("on", calibrationMode);
    });
  }
}

/* =========================
   MAP PAN / ZOOM + CALIBRATION
   ========================= */
function wireMap() {
  if (!el.mapContainer || !el.mapWrapper) return;

  // Mouse pan
  el.mapContainer.addEventListener("mousedown", startPan);
  document.addEventListener("mousemove", panMove);
  document.addEventListener("mouseup", endPan);

  // Touch pan
  el.mapContainer.addEventListener("touchstart", startPan, { passive: false });
  document.addEventListener("touchmove", panMove, { passive: false });
  document.addEventListener("touchend", endPan);

  // Click calibration (reports x/y %)
  el.mapContainer.addEventListener("click", (e) => {
    if (!calibrationMode) return;

    // ignore clicks on UI overlays
    if (e.target.closest(".ui") || e.target.closest(".tabs") || e.target.closest(".controls")) return;

    const { x, y } = getPercentCoordsFromEvent(e);
    alert(`Waypoint coords:\n  x: ${x}\n  y: ${y}\n\nPaste into WAYPOINTS for that location.`);
    console.log("Calibration coords:", { x, y });
  });

  // Zoom controls
  if (el.zoomIn) el.zoomIn.addEventListener("click", () => zoomBy(1.2));
  if (el.zoomOut) el.zoomOut.addEventListener("click", () => zoomBy(1 / 1.2));
  if (el.zoomReset) el.zoomReset.addEventListener("click", () => { scale = 1; centerOnStart(); });

  // Pinch zoom
  let lastDist = 0;
  el.mapContainer.addEventListener("touchstart", (e) => {
    if (e.touches.length === 2) {
      lastDist = touchDist(e.touches[0], e.touches[1]);
    }
  }, { passive: false });

  el.mapContainer.addEventListener("touchmove", (e) => {
    if (e.touches.length === 2) {
      e.preventDefault();
      const d = touchDist(e.touches[0], e.touches[1]);
      const delta = d - lastDist;
      if (Math.abs(delta) > 1) {
        zoomBy(delta > 0 ? 1.04 : 0.96);
        lastDist = d;
      }
    }
  }, { passive: false });
}

function startPan(e) {
  if (e.touches && e.touches.length > 1) return;
  // don‚Äôt pan when clicking waypoint marker (SVG)
  if (e.target.closest("svg")) return;

  isPanning = true;
  if (el.mapContainer) el.mapContainer.classList.add("grabbing");

  const p = getClientPoint(e);
  startX = p.x - translateX;
  startY = p.y - translateY;
}

function panMove(e) {
  if (!isPanning) return;
  if (e.touches && e.touches.length > 1) return;
  const p = getClientPoint(e);

  translateX = p.x - startX;
  translateY = p.y - startY;
  applyTransform();
}

function endPan() {
  isPanning = false;
  if (el.mapContainer) el.mapContainer.classList.remove("grabbing");
}

function zoomBy(factor) {
  const next = Math.max(CONFIG.MIN_SCALE, Math.min(CONFIG.MAX_SCALE, scale * factor));
  scale = next;
  applyTransform();
}

function applyTransform() {
  el.mapWrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
}

function centerOnStart() {
  if (!el.mapImage || !el.mapContainer) return;
  const start = WAYPOINTS[0];
  const container = el.mapContainer.getBoundingClientRect();

  const imgW = el.mapImage.naturalWidth || el.mapImage.width;
  const imgH = el.mapImage.naturalHeight || el.mapImage.height;

  translateX = container.width / 2 - (imgW * start.x / 100) * scale;
  translateY = container.height / 2 - (imgH * start.y / 100) * scale;

  applyTransform();
}

function getPercentCoordsFromEvent(e) {
  const rect = el.mapImage.getBoundingClientRect();
  const p = getClientPoint(e);

  const xPx = (p.x - rect.left) / rect.width;
  const yPx = (p.y - rect.top) / rect.height;

  const x = Math.max(0, Math.min(1, xPx)) * 100;
  const y = Math.max(0, Math.min(1, yPx)) * 100;

  return { x: +x.toFixed(2), y: +y.toFixed(2) };
}

function getClientPoint(e) {
  if (e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  return { x: e.clientX, y: e.clientY };
}

function touchDist(a, b) {
  const dx = a.clientX - b.clientX;
  const dy = a.clientY - b.clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

/* =========================
   WAYPOINT MODAL
   ========================= */
function openWaypointModal(w) {
  if (!el.waypointModal || !el.modalTitle) return;
  el.modalTitle.textContent = w.name;
  if (el.modalDistance) el.modalDistance.textContent = `${w.distance} km from The Shire`;
  if (el.modalLore) el.modalLore.textContent = w.lore || "";
  el.waypointModal.classList.add("active");
}

/* =========================
   ENTRY ACTIONS
   ========================= */
function onAddEntry() {
  const d = parseFloat(el.distanceInput?.value || "");
  if (!d || d <= 0) {
    alert("Please enter a valid distance.");
    return;
  }
  const note = (el.noteInput?.value || "").trim();

  const entry = {
    id: Date.now(),
    date: new Date().toISOString().split("T")[0],
    distance: d,
    note
  };

  entries.push(entry);
  // Keep entries sorted by date (optional, but helps streak logic)
  entries.sort((a, b) => new Date(a.date) - new Date(b.date));

  saveEntries();

  if (el.distanceInput) el.distanceInput.value = "";
  if (el.noteInput) el.noteInput.value = "";

  // Re-render
  renderRoute();
  renderWaypoints();
  updateComputedUI();
}

function resetJourney() {
  const ok = confirm("Reset journey? This deletes all entries and cannot be undone.");
  if (!ok) return;
  entries = [];
  saveEntries();
  renderRoute();
  renderWaypoints();
  updateComputedUI();
}

function exportCSV() {
  if (entries.length === 0) return;

  const headers = ["Date", "Distance (km)", "Note"];
  const lines = [headers.join(",")];

  entries.forEach(e => {
    const row = [
      e.date,
      Number(e.distance || 0),
      csvEscape(e.note || "")
    ];
    lines.push(row.join(","));
  });

  const blob = new Blob([lines.join("\n")], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `frodo-journey-${new Date().toISOString().split("T")[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function handleCSVImport(evt) {
  const file = evt.target.files?.[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    const text = String(e.target.result || "");
    const imported = parseCSV(text);

    // expects columns: Date, Distance (km), Note
    const rows = imported.slice(1); // skip header
    const next = [];

    rows.forEach(cols => {
      if (!cols || cols.length < 2) return;
      const date = (cols[0] || "").trim();
      const dist = parseFloat((cols[1] || "").trim());
      const note = (cols[2] || "").trim();

      if (!date || !dist || dist <= 0) return;
      next.push({
        id: Date.now() + Math.random(),
        date,
        distance: dist,
        note
      });
    });

    entries = entries.concat(next);
    entries.sort((a, b) => new Date(a.date) - new Date(b.date));
    saveEntries();

    renderRoute();
    renderWaypoints();
    updateComputedUI();

    // reset input so same file can be re-imported if needed
    evt.target.value = "";
  };
  reader.readAsText(file);
}

/* =========================
   MATH HELPERS
   ========================= */
function calculatePolylineLength(points) {
  let len = 0;
  for (let i = 1; i < points.length; i++) {
    const dx = points[i].x - points[i - 1].x;
    const dy = points[i].y - points[i - 1].y;
    len += Math.sqrt(dx * dx + dy * dy);
  }
  return len;
}

/* =========================
   STATS HELPERS
   ========================= */
function calculate7DayAverage(entriesArr) {
  if (!entriesArr.length) return 0;
  const last7 = entriesArr.slice(-7);
  const sum = last7.reduce((s, e) => s + (Number(e.distance) || 0), 0);
  return last7.length ? sum / last7.length : 0;
}

function calculateUserPace(entriesArr) {
  if (!entriesArr.length) return 0;
  const sorted = entriesArr.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
  const start = new Date(sorted[0].date);
  const end = new Date(sorted[sorted.length - 1].date);

  start.setHours(0,0,0,0);
  end.setHours(0,0,0,0);

  const days = Math.max(1, Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1);
  return totalWalked() / days;
}

function calculateLongestStreak(entriesArr) {
  if (!entriesArr.length) return 0;
  const sorted = entriesArr.slice().sort((a, b) => new Date(a.date) - new Date(b.date));

  let longest = 1;
  let cur = 1;

  for (let i = 1; i < sorted.length; i++) {
    const prev = new Date(sorted[i - 1].date);
    const now = new Date(sorted[i].date);
    prev.setHours(0,0,0,0);
    now.setHours(0,0,0,0);

    const diff = Math.floor((now - prev) / (1000 * 60 * 60 * 24));
    if (diff === 1) {
      cur++;
      longest = Math.max(longest, cur);
    } else if (diff > 1) {
      cur = 1;
    }
  }
  return longest;
}

function calculateCurrentStreak(entriesArr) {
  if (!entriesArr.length) return 0;
  const sorted = entriesArr.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

  const today = new Date();
  today.setHours(0,0,0,0);

  let streak = 0;
  let check = new Date(today);

  for (const e of sorted) {
    const d = new Date(e.date);
    d.setHours(0,0,0,0);

    const diff = Math.floor((check - d) / (1000 * 60 * 60 * 24));
    if (diff === 0 || diff === 1) {
      streak++;
      check = new Date(d);
      check.setDate(check.getDate() - 1);
    } else {
      break;
    }
  }
  return streak;
}

/* =========================
   SVG + CSV + SAFETY UTILS
   ========================= */
function svgEl(tag, attrs = {}, text = null) {
  const n = document.createElementNS("http://www.w3.org/2000/svg", tag);
  Object.entries(attrs).forEach(([k, v]) => n.setAttribute(k, String(v)));
  if (text !== null) n.textContent = text;
  return n;
}

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, s => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
  }[s]));
}

function csvEscape(s) {
  const t = String(s);
  if (/[,"\n]/.test(t)) return `"${t.replace(/"/g, '""')}"`;
  return t;
}

// Very small CSV parser that respects quoted values
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];

    if (ch === '"' && inQuotes && next === '"') {
      cur += '"';
      i++;
      continue;
    }
    if (ch === '"') {
      inQuotes = !inQuotes;
      continue;
    }
    if (ch === "," && !inQuotes) {
      row.push(cur);
      cur = "";
      continue;
    }
    if ((ch === "\n" || ch === "\r") && !inQuotes) {
      if (ch === "\r" && next === "\n") i++;
      row.push(cur);
      rows.push(row);
      row = [];
      cur = "";
      continue;
    }
    cur += ch;
  }

  // flush last cell
  if (cur.length || row.length) {
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

/* =========================
   BOOT
   ========================= */
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}
</script>
