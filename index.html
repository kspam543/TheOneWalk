<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>The One Walk - Journey to Mount Doom</title>

  <style>
    :root{
      /* ========= QUICK SIZING CONTROLS (edit these) ========= */
      --route-base-width: 0.30;        /* base route thickness (SVG units) */
      --route-completed-width: 0.40;   /* completed route thickness */
      --route-base-opacity: 0.35;

      --waypoint-r: 0.45;              /* waypoint radius */
      --waypoint-r-current: 0.65;      /* current waypoint radius */
      --waypoint-stroke: 0.16;         /* waypoint stroke width */
      --waypoint-inner-r: 0.16;

      --marker-ring-r: 0.95;
      --marker-outer-r: 0.55;
      --marker-inner-r: 0.25;
      --marker-emoji-size: 1.3;

      /* Map card height */
      --map-height: 520px;             /* desktop */
      --map-height-mobile: 420px;      /* mobile */
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body{
      font-family: Georgia, serif;
      background: #fff7e6;
      color: #5b3a1e;
      min-height: 100vh;
    }

    /* subtle paper lines */
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:0.18;
      background-image: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(101, 67, 33, 0.05) 2px,
        rgba(101, 67, 33, 0.05) 4px
      );
    }

    .container{
      position:relative;
      z-index:1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px 60px;
    }

    header{
      text-align:center;
      padding-top: 8px;
      margin-bottom: 18px;
    }
    header h1{
      font-size: 44px;
      font-weight: 800;
      color:#6b3f1f;
      letter-spacing: 0.3px;
    }
    header p{
      margin-top: 6px;
      color:#8a5a32;
    }
    header .sub{
      margin-top: 4px;
      font-size: 12px;
      color:#9a6a3a;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:10px;
      justify-content:flex-start;
      flex-wrap:wrap;
      margin: 12px 0 18px;
    }
    .tab-btn{
      display:flex;
      align-items:center;
      gap:8px;
      border:none;
      cursor:pointer;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 14px;
      transition: background 0.15s ease;
      background:#f3d9a6;
      color:#5b3a1e;
      box-shadow: 0 2px 0 rgba(0,0,0,0.05);
    }
    .tab-btn.active{
      background:#8a4f25;
      color:#fff;
    }

    /* Cards */
    .card{
      background: linear-gradient(135deg, #fff3d6, #fffaea);
      border: 2px solid #f1c97a;
      border-radius: 12px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
      padding: 16px;
      margin-bottom: 16px;
    }

    .card h2{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 18px;
      color:#6b3f1f;
      margin-bottom: 12px;
    }

    /* Journey overview */
    .overview-top{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .overview-left{
      flex: 1 1 420px;
      min-width: 260px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#ffe5b5;
      color:#6b3f1f;
      border: 1px solid #f1c97a;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      margin-top: 8px;
      width:fit-content;
    }
    .pill .emoji{ font-size: 18px; }
    .tip{
      font-size: 12px;
      color:#8a5a32;
      margin-top: 6px;
      margin-left: 6px;
    }

    .next-box{
      text-align:right;
      flex: 0 0 auto;
      min-width: 180px;
      padding-top: 2px;
    }
    .next-box .label{
      font-size: 12px;
      color:#8a5a32;
    }
    .next-box .big{
      font-size: 28px;
      font-weight: 800;
      color:#6b3f1f;
    }

    .bar{
      position:relative;
      height: 14px;
      background:#f7dba7;
      border-radius: 999px;
      overflow:hidden;
      margin: 12px 0 12px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #16a34a, #f59e0b, #dc2626);
      transition: width 0.4s ease;
    }

    .overview-metrics{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      text-align:center;
      margin-top: 4px;
    }
    .metric .num{
      font-size: 26px;
      font-weight: 800;
      color:#6b3f1f;
      line-height: 1.1;
    }
    .metric .lbl{
      font-size: 12px;
      color:#8a5a32;
    }

    /* Map card */
    .map-wrap{
      border: 2px solid #cc7a27;
      border-radius: 12px;
      overflow:hidden;
      background: #f5e6d3;
      position:relative;
      height: var(--map-height);
    }
    @media (max-width: 700px){
      header h1{ font-size: 36px; }
      .map-wrap{ height: var(--map-height-mobile); }
      .overview-metrics{ grid-template-columns: 1fr; }
      .next-box{ text-align:left; }
    }

    /* Map viewport (pan/zoom area) */
    #map-viewport{
      position:absolute;
      inset:0;
      overflow:hidden;
      touch-action:none;
      cursor:grab;
    }
    #map-viewport.grabbing{ cursor:grabbing; }

    #map-wrapper{
      position: relative;
      display: inline-block;
      transform-origin: 0 0;
      will-change: transform;
    }

    #map-image{
      display:block;
      width:auto;
      height:auto;
      max-width:none;
      user-select:none;
      -webkit-user-drag:none;
    }

    #route-overlay{
      position:absolute;
      top:0; left:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }

    /* Route */
    .route-base{
      fill:none;
      stroke:#6b4423;
      stroke-width: var(--route-base-width);
      opacity: var(--route-base-opacity);
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 1.2 0.9;
    }
    .route-completed{
      fill:none;
      stroke: url(#route-gradient);
      stroke-width: var(--route-completed-width);
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 3px rgba(220,38,38,0.35));
    }

    /* Waypoints */
    .waypoint { transform-box: fill-box; transform-origin: center; }
    .wp-hit { cursor:pointer; pointer-events:auto; }
    .waypoint:hover .wp-outer { r: calc(var(--waypoint-r) + 0.12); }

    .wp-outer{
      r: var(--waypoint-r);
      stroke-width: var(--waypoint-stroke);
    }
    .wp-inner{ r: var(--waypoint-inner-r); }

    .wp-reached .wp-outer{ fill:#16a34a; stroke:#fff4db; }
    .wp-unreached .wp-outer{ fill:#f59e0b; stroke:#78350f; }
    .wp-current .wp-outer{
      fill:#dc2626; stroke:#fff4db;
      animation: pulse 1.9s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ opacity:1; }
      50%{ opacity:0.75; }
    }

    /* Marker */
    #marker{
      filter: drop-shadow(0 1px 6px rgba(0,0,0,0.35));
    }

    /* Map overlays */
    .map-hint{
      margin-top: 10px;
      font-size: 12px;
      color:#8a5a32;
      text-align:center;
    }

    /* Map controls */
    .map-controls{
      position:absolute;
      right: 12px;
      top: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      z-index: 5;
    }
    .ctrl-btn{
      width:44px;
      height:44px;
      border-radius: 999px;
      border: 2px solid #f1c97a;
      background: rgba(255, 250, 234, 0.95);
      font-size: 20px;
      font-weight: 800;
      cursor:pointer;
      color:#6b3f1f;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    .ctrl-btn:active{ transform: scale(0.98); }

    /* Stats cards (like your screenshot) */
    .grid4{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 900px){
      .grid4{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .statbox{
      border-radius: 10px;
      padding: 12px;
      border: 2px solid rgba(0,0,0,0.06);
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }
    .statbox .t{ font-size: 12px; margin-bottom: 6px; opacity: 0.9; }
    .statbox .v{ font-size: 32px; font-weight: 900; line-height: 1; }
    .statbox .u{ font-size: 12px; margin-top: 4px; opacity:0.85; }

    .g-green{ background: linear-gradient(135deg, #d1fae5, #a7f3d0); color:#064e3b; border-color:#34d399; }
    .g-blue{  background: linear-gradient(135deg, #dbeafe, #bfdbfe); color:#1e3a8a; border-color:#60a5fa; }
    .g-purple{background: linear-gradient(135deg, #ede9fe, #ddd6fe); color:#4c1d95; border-color:#a78bfa; }
    .g-orange{background: linear-gradient(135deg, #ffedd5, #fde68a); color:#7c2d12; border-color:#fb923c; }

    /* Pace analysis block */
    .pace{
      background: linear-gradient(135deg, #fff3d6, #fffbe9);
      border: 2px solid #f1c97a;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
    }
    .pace h3{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 18px;
      margin-bottom: 12px;
      color:#6b3f1f;
    }
    .pace .cols{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }
    @media (max-width: 750px){
      .pace .cols{ grid-template-columns: 1fr; }
    }
    .pace .k{ font-size: 12px; color:#8a5a32; }
    .pace .b{ font-size: 26px; font-weight: 900; color:#6b3f1f; }

    .note{
      margin-top: 12px;
      padding: 12px;
      background:#fff7d0;
      border: 1px solid #f1c97a;
      border-radius: 10px;
      color:#6b3f1f;
      font-size: 13px;
    }

    /* Log cards */
    .blue-card{
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border: 2px solid #93c5fd;
      color:#1e3a8a;
    }
    .purple-card{
      background: linear-gradient(135deg, #f5f3ff, #ede9fe);
      border: 2px solid #c4b5fd;
      color:#4c1d95;
    }

    label{ display:block; font-size: 13px; font-weight: 700; margin-bottom: 6px; }
    input[type="number"], input[type="text"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 2px solid rgba(30,58,138,0.18);
      font-size: 16px;
      font-family: Georgia, serif;
      background:#fff;
      color:#1f2937;
    }

    .btn{
      width:100%;
      padding: 14px;
      border-radius: 12px;
      border:none;
      cursor:pointer;
      font-weight: 900;
      font-size: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: filter 0.12s ease;
    }
    .btn:hover{ filter: brightness(0.98); }
    .btn-blue{ background:#2563eb; color:#fff; }
    .btn-purple{ background:#7c3aed; color:#fff; }
    .btn-green{ background:#16a34a; color:#fff; }
    .btn-red{ background:#dc2626; color:#fff; }

    .actions{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .small{
      font-size: 12px;
      opacity: 0.85;
      margin-top: 10px;
      background: rgba(255,255,255,0.55);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.07);
    }

    /* Recent entries */
    .recent{
      background:#fff;
      border: 2px solid #f1c97a;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.06);
    }
    .recent h2{
      margin-bottom: 10px;
    }
    .entry{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
      background:#fff6dc;
      border: 1px solid #f1c97a;
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 8px;
    }
    .entry .d{ font-weight: 800; color:#6b3f1f; }
    .entry .n{ font-size: 12px; color:#8a5a32; margin-top: 2px; }
    .entry .km{ font-weight: 900; font-size: 18px; color:#6b3f1f; }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 100;
    }
    .modal-backdrop.active{ display:flex; }
    .modal{
      width: min(520px, 100%);
      background: linear-gradient(135deg, #fff7e6, #fffaea);
      border: 3px solid #f1c97a;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.3);
    }
    .modal-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom: 10px;
    }
    .modal h3{
      font-size: 22px;
      color:#6b3f1f;
      font-weight: 900;
    }
    .xbtn{
      border:none;
      cursor:pointer;
      background:#f3d9a6;
      color:#6b3f1f;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 900;
    }
    .modal .k{ font-size: 12px; color:#8a5a32; margin-top: 6px; }
    .modal .v{ font-size: 18px; font-weight: 900; color:#6b3f1f; }
    .lore{
      margin-top: 12px;
      background:#fff1c8;
      border: 1px solid #f1c97a;
      border-radius: 12px;
      padding: 12px;
      font-style: italic;
      color:#6b3f1f;
      line-height: 1.5;
      font-size: 14px;
    }

    /* Calibration button */
    .calib{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .calib button{
      background:#8a4f25;
      color:#fff;
      border:none;
      border-radius: 12px;
      padding: 12px;
      cursor:pointer;
      font-weight: 900;
    }
    .calib .hint{
      font-size: 12px;
      color:#8a5a32;
    }

    /* Hide/Show tabs */
    .tab{ display:none; }
    .tab.active{ display:block; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>The One Walk</h1>
      <p>Track your journey to Mount Doom</p>
      <div class="sub"><span id="totalDistanceLabel"></span> km ‚Ä¢ Based on Tolkien's timeline</div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="journey">üß≠ Journey</button>
      <button class="tab-btn" data-tab="stats">üìä Statistics</button>
      <button class="tab-btn" data-tab="log">‚ûï Log Walk</button>
    </div>

    <!-- JOURNEY TAB -->
    <section class="tab active" id="tab-journey">
      <div class="card" id="journeyOverview">
        <div class="overview-top">
          <div class="overview-left">
            <div style="display:flex; align-items:center; gap:10px;">
              <div style="font-size:22px;">üìç</div>
              <div style="font-weight:900; font-size:18px; color:#6b3f1f;" id="currentWaypointName">‚Äî</div>
            </div>
            <div style="margin-top:4px; font-size:13px; color:#8a5a32;" id="currentWaypointDesc">‚Äî</div>

            <div class="pill" id="terrainPill">
              <span class="emoji">üö∂</span>
              <span style="font-weight:800;">Regular walking</span>
            </div>
            <div class="tip" id="terrainTip">üí° Maintain a steady, comfortable pace</div>
          </div>

          <div class="next-box">
            <div class="label">Next waypoint in</div>
            <div class="big" id="nextKm">‚Äî</div>
            <div style="font-size:12px; color:#8a5a32;">km</div>
          </div>
        </div>

        <div class="bar"><div id="progressFill"></div></div>

        <div class="overview-metrics">
          <div class="metric">
            <div class="num" id="kmWalked">0.0</div>
            <div class="lbl">km walked</div>
          </div>
          <div class="metric">
            <div class="num" id="pctComplete">0.0%</div>
            <div class="lbl">complete</div>
          </div>
          <div class="metric">
            <div class="num" id="kmRemaining">0</div>
            <div class="lbl">km to go</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üìç Interactive Map of Middle-earth</h2>

        <div class="map-wrap">
          <div class="map-controls">
            <button class="ctrl-btn" id="zoomIn">+</button>
            <button class="ctrl-btn" id="zoomOut">‚àí</button>
            <button class="ctrl-btn" id="zoomReset" style="font-size:18px;">‚ü≤</button>
          </div>

          <div id="map-viewport">
            <div id="map-wrapper">
              <img id="map-image" src="middle-earth-map.jpg" alt="Middle-earth Map" />
              <svg id="route-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
                <defs>
                  <linearGradient id="route-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#16a34a;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#f59e0b;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                  </linearGradient>
                </defs>

                <path id="route-base" class="route-base"></path>
                <path id="route-completed" class="route-completed"></path>

                <g id="waypoints"></g>

                <!-- Current position marker -->
                <g id="marker">
                  <circle id="marker-ring" fill="none" stroke="#dc2626" opacity="0.55"></circle>
                  <circle id="marker-outer" fill="#dc2626" stroke="#fff4db"></circle>
                  <circle id="marker-inner" fill="#fff4db"></circle>
                  <text id="marker-emoji" text-anchor="middle" fill="#fff4db">üßô‚Äç‚ôÇÔ∏è</text>
                </g>

                <!-- Compass -->
                <g transform="translate(93, 7)" opacity="0.65">
                  <circle r="3" fill="#fff4db" stroke="#92400e" stroke-width="0.2"></circle>
                  <path d="M 0 -2.5 L 0.4 0 L 0 2.5 L -0.4 0 Z" fill="#dc2626"></path>
                  <path d="M -2.5 0 L 0 -0.4 L 2.5 0 L 0 0.4 Z" fill="#475569"></path>
                  <text y="-3.5" font-size="1.5" fill="#1e293b" text-anchor="middle" font-weight="bold">N</text>
                </g>
              </svg>
            </div>
          </div>
        </div>

        <div class="calib">
          <button id="calibrateBtn">üéØ Calibration Mode: OFF</button>
          <div class="hint">
            Turn ON, then click the exact waypoint location on your map to get x/y percent coordinates to paste into the WAYPOINTS array.
          </div>
        </div>

        <div class="map-hint">Click a waypoint to view details ‚Ä¢ Pan/zoom the map ‚Ä¢ Your coordinates use a 0‚Äì100 overlay grid</div>
      </div>
    </section>

    <!-- STATS TAB -->
    <section class="tab" id="tab-stats">
      <div class="grid4">
        <div class="statbox g-green">
          <div class="t">Current Streak</div>
          <div class="v" id="statCurrentStreak">0</div>
          <div class="u">days</div>
        </div>
        <div class="statbox g-blue">
          <div class="t">Longest Streak</div>
          <div class="v" id="statLongestStreak">0</div>
          <div class="u">days</div>
        </div>
        <div class="statbox g-purple">
          <div class="t">7-Day Average</div>
          <div class="v" id="statAvg7">0.0</div>
          <div class="u">km/day</div>
        </div>
        <div class="statbox g-orange">
          <div class="t">Your Pace vs Frodo</div>
          <div class="v" id="statPaceVs">0%</div>
          <div class="u" id="statPaceVsHint">Start walking</div>
        </div>
      </div>

      <div style="margin-top:16px;" class="pace">
        <h3>üî• Pace Analysis</h3>
        <div class="cols">
          <div>
            <div class="k">Your Daily Pace</div>
            <div class="b" id="statUserPace">0.0 km/day</div>
            <div class="k" id="statDaysSince">Based on 0 days</div>
          </div>
          <div>
            <div class="k">Frodo's Pace (from books)</div>
            <div class="b" id="statFrodoPace">52.1 km/day</div>
            <div class="k">55 days, The Shire to Mount Doom</div>
          </div>
        </div>
        <div class="note" id="paceNote">üéØ Start your first walk to begin comparing your pace to Frodo‚Äôs journey.</div>
      </div>
    </section>

    <!-- LOG TAB -->
    <section class="tab" id="tab-log">
      <div class="card blue-card">
        <h2>üìÖ Log Today's Walk</h2>

        <div style="display:grid; gap:12px;">
          <div>
            <label for="distanceInput">Distance (km)</label>
            <input type="number" id="distanceInput" step="0.1" placeholder="5.0" />
          </div>
          <div>
            <label for="noteInput">Note (optional)</label>
            <input type="text" id="noteInput" placeholder="Morning walk in the park..." />
          </div>

          <button class="btn btn-blue" id="addEntryBtn">‚ûï Add Entry</button>
        </div>
      </div>

      <div class="card purple-card">
        <h2>‚¨ÜÔ∏è Import from Fitness Apps</h2>
        <div style="font-size:13px; margin-bottom:10px;">
          Import walking data from Apple Health, Garmin, Strava, etc. CSV columns: <strong>Date, Distance (km), Note</strong>
        </div>

        <label class="btn btn-purple" style="cursor:pointer;">
          ‚¨ÜÔ∏è Choose CSV File
          <input type="file" id="csvInput" accept=".csv" style="display:none;">
        </label>

        <div class="small">
          <strong>Note:</strong> Your data is saved locally on this device. To sync across devices, export/import the CSV.
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-green" id="exportBtn">‚¨áÔ∏è Export CSV</button>
        <button class="btn btn-red" id="resetBtn">‚ü≤ Reset Journey</button>
      </div>

      <div class="recent" id="recentCard" style="margin-top:16px; display:none;">
        <h2>Recent Walks</h2>
        <div id="recentList"></div>
      </div>
    </section>

  </div>

  <!-- Waypoint modal -->
  <div class="modal-backdrop" id="wpModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-top">
        <h3 id="wpTitle">‚Äî</h3>
        <button class="xbtn" id="wpClose">‚úï</button>
      </div>
      <div class="k">Distance from start</div>
      <div class="v" id="wpDist">‚Äî</div>
      <div class="k" style="margin-top:10px;">Terrain</div>
      <div class="v" id="wpTerrain">‚Äî</div>

      <div class="lore" id="wpLore">‚Äî</div>
    </div>
  </div>

<script>

/***********************
 * CONFIG + DATA
 ***********************/
const MAP_IMAGE_SRC = "middle-earth-map.jpg";

// Frodo timeline
const TOTAL_DISTANCE = 2863;
const FRODO_TIMELINE_DAYS = 55;
const FRODO_DAILY_PACE = TOTAL_DISTANCE / FRODO_TIMELINE_DAYS;

// Local storage key
const STORAGE_KEY = "frodoJourneyEntries";

// Terrain suggestions
const TERRAIN_SUGGESTIONS = {
  flat:     { icon: "üö∂", activity: "Regular walking",       tip: "Maintain a steady, comfortable pace" },
  hills:    { icon: "‚õ∞Ô∏è", activity: "Hill training",          tip: "Find local hills or use incline on a treadmill" },
  mountain: { icon: "üèîÔ∏è", activity: "Stair climbing",         tip: "Use stairs, stadium steps, or a StairMaster" },
  valley:   { icon: "üå≤", activity: "Trail walking",          tip: "Walk on uneven terrain or nature trails" },
  marsh:    { icon: "üíß", activity: "Resistance training",    tip: "Sand/water walking, or light ankle weights" },
  volcanic: { icon: "üåã", activity: "HIIT intervals",         tip: "Intervals with walking recovery" }
};

// Your calibrated WAYPOINTS (0‚Äì100 overlay coords)
const WAYPOINTS = [
  { id: 1,  name: "Bag End, The Shire",          distance: 0,    segment: 0,   x: 35.09, y: 26.91, terrain:"flat",     description: "Green rolling hills, comfortable and peaceful", lore: "Home of Bilbo and Frodo Baggins. Your adventure begins at the round green door of Bag End in Hobbiton." },
  { id: 2,  name: "Bucklebury Ferry",           distance: 28,   segment: 28,  x: 20.00, y: 29.00, terrain:"flat",     description: "River crossing through gentle farmland", lore: "The hobbits cross the Brandywine River, narrowly escaping the Black Riders pursuing them from the Shire." },
  { id: 3,  name: "Bree",                       distance: 165,  segment: 137, x: 26.00, y: 34.00, terrain:"flat",     description: "Village at the crossroads", lore: "A village where Men and Hobbits dwell together. Here at The Prancing Pony, Frodo meets the mysterious Strider." },
  { id: 4,  name: "Weathertop",                 distance: 280,  segment: 115, x: 32.00, y: 32.00, terrain:"hills",    description: "Ancient ruins atop windswept hills", lore: "Ruins of the great watchtower. Here Frodo is wounded by the blade of the Witch-king." },
  { id: 5,  name: "Ford of Bruinen",            distance: 440,  segment: 160, x: 38.00, y: 29.00, terrain:"hills",    description: "Swift waters at Rivendell's border", lore: "The enchanted river protecting Rivendell. The Nazg√ªl are swept away by Elrond's flood." },
  { id: 6,  name: "Rivendell",                  distance: 458,  segment: 18,  x: 50.95, y: 25.88, terrain:"valley",   description: "The Last Homely House", lore: "Imladris, refuge of Elrond. Here the Fellowship is formed and the fate of the Ring is decided." },
  { id: 7,  name: "Hollin Gate",                distance: 680,  segment: 222, x: 45.00, y: 35.00, terrain:"hills",    description: "Rocky foothills below Misty Mountains", lore: "The ancient elvish realm of Eregion, where the Rings of Power were forged." },
  { id: 8,  name: "Moria",                      distance: 850,  segment: 170, x: 48.00, y: 38.00, terrain:"mountain", description: "Dark tunnels through mountain depths", lore: "The greatest of Dwarf-cities, now fallen to shadow. Here Gandalf faces the Balrog." },
  { id: 9,  name: "Lothl√≥rien",                 distance: 1020, segment: 170, x: 53.00, y: 42.00, terrain:"flat",     description: "Golden wood of the Galadhrim", lore: "Realm of Galadriel and Celeborn, where time moves differently." },
  { id: 10, name: "Amon Hen",                   distance: 1260, segment: 240, x: 53.00, y: 52.00, terrain:"hills",    description: "Hill of Sight above the great river", lore: "The Seat of Seeing. Here the Fellowship is broken and the Three Hunters begin their chase." },
  { id: 11, name: "Emyn Muil",                  distance: 1380, segment: 120, x: 56.00, y: 55.00, terrain:"mountain", description: "Maze of sharp rocky peaks", lore: "A treacherous labyrinth of stone where Frodo and Sam are lost for days." },
  { id: 12, name: "Dead Marshes",               distance: 1540, segment: 160, x: 60.00, y: 57.00, terrain:"marsh",    description: "Haunted wetlands", lore: "Ancient battlefield where the last alliance fought Sauron. The dead lie preserved in dark waters." },
  { id: 13, name: "Black Gate",                 distance: 1720, segment: 180, x: 64.00, y: 58.00, terrain:"flat",     description: "The great gate of Mordor", lore: "The mighty gateway to Mordor. Too well guarded for passage." },
  { id: 14, name: "Ithilien",                   distance: 1870, segment: 150, x: 66.00, y: 63.00, terrain:"hills",    description: "Fair woodland on Mordor's border", lore: "Once the garden of Gondor. Faramir's rangers ambush Southrons here." },
  { id: 15, name: "Cirith Ungol",               distance: 2120, segment: 250, x: 70.00, y: 68.00, terrain:"mountain", description: "The high pass guarded by Shelob", lore: "The pass of the spider, where Shelob the Great makes her lair." },
  { id: 16, name: "Tower of Cirith Ungol",      distance: 2150, segment: 30,  x: 71.00, y: 69.00, terrain:"mountain", description: "Evil fortress at the pass", lore: "Orc-tower watching the pass. Frodo is held prisoner here until Sam rescues him." },
  { id: 17, name: "Morgul Vale",                distance: 2240, segment: 90,  x: 72.00, y: 72.00, terrain:"valley",   description: "Valley of evil sorcery", lore: "Minas Morgul glows with corpse-light in this cursed valley." },
  { id: 18, name: "Gorgoroth Plains",           distance: 2550, segment: 310, x: 77.00, y: 78.00, terrain:"volcanic", description: "Ashen wasteland within Mordor", lore: "The desolate plateau of Mordor, filled with orc armies and the smoke of Mount Doom." },
  { id: 19, name: "Mount Doom",                 distance: 2863, segment: 313, x: 70.49, y: 57.72, terrain:"volcanic", description: "The fires where the Ring was forged", lore: "Orodruin, the Mountain of Fire. Here the Ring must be unmade." }
];

/***********************
 * STATE
 ***********************/
let entries = [];              // {id, date(YYYY-MM-DD), distance, note}
let calibrationMode = false;

// pan/zoom state
let scale = 1;
let translateX = 0;
let translateY = 0;
let isPanning = false;
let panStartClientX = 0;
let panStartClientY = 0;
let panStartTranslateX = 0;
let panStartTranslateY = 0;

/***********************
 * DOM HOOKS (YOUR IDs)
 ***********************/
const dom = {
  // Tabs
  tabButtons: Array.from(document.querySelectorAll(".tab-btn")),
  tabJourney: document.getElementById("tab-journey"),
  tabStats: document.getElementById("tab-stats"),
  tabLog: document.getElementById("tab-log"),

  // Journey overview
  totalDistanceLabel: document.getElementById("totalDistanceLabel"),
  currentWaypointName: document.getElementById("currentWaypointName"),
  currentWaypointDesc: document.getElementById("currentWaypointDesc"),
  terrainPill: document.getElementById("terrainPill"),
  terrainTip: document.getElementById("terrainTip"),
  nextKm: document.getElementById("nextKm"),
  kmWalked: document.getElementById("kmWalked"),
  pctComplete: document.getElementById("pctComplete"),
  kmRemaining: document.getElementById("kmRemaining"),
  progressFill: document.getElementById("progressFill"),

  // Map
  mapViewport: document.getElementById("map-viewport"),
  mapWrapper: document.getElementById("map-wrapper"),
  mapImage: document.getElementById("map-image"),
  routeOverlay: document.getElementById("route-overlay"),
  routeBase: document.getElementById("route-base"),
  routeCompleted: document.getElementById("route-completed"),
  waypointsGroup: document.getElementById("waypoints"),
  marker: document.getElementById("marker"),
  markerRing: document.getElementById("marker-ring"),
  markerOuter: document.getElementById("marker-outer"),
  markerInner: document.getElementById("marker-inner"),
  markerEmoji: document.getElementById("marker-emoji"),

  zoomIn: document.getElementById("zoomIn"),
  zoomOut: document.getElementById("zoomOut"),
  zoomReset: document.getElementById("zoomReset"),

  // Calibration
  calibrateBtn: document.getElementById("calibrateBtn"),

  // Stats tab
  statCurrentStreak: document.getElementById("statCurrentStreak"),
  statLongestStreak: document.getElementById("statLongestStreak"),
  statAvg7: document.getElementById("statAvg7"),
  statPaceVs: document.getElementById("statPaceVs"),
  statPaceVsHint: document.getElementById("statPaceVsHint"),
  statUserPace: document.getElementById("statUserPace"),
  statDaysSince: document.getElementById("statDaysSince"),
  statFrodoPace: document.getElementById("statFrodoPace"),
  paceNote: document.getElementById("paceNote"),

  // Log tab
  distanceInput: document.getElementById("distanceInput"),
  noteInput: document.getElementById("noteInput"),
  addEntryBtn: document.getElementById("addEntryBtn"),
  csvInput: document.getElementById("csvInput"),
  exportBtn: document.getElementById("exportBtn"),
  resetBtn: document.getElementById("resetBtn"),
  recentCard: document.getElementById("recentCard"),
  recentList: document.getElementById("recentList"),

  // Modal
  wpModalBackdrop: document.getElementById("wpModalBackdrop"),
  wpTitle: document.getElementById("wpTitle"),
  wpDist: document.getElementById("wpDist"),
  wpTerrain: document.getElementById("wpTerrain"),
  wpLore: document.getElementById("wpLore"),
  wpClose: document.getElementById("wpClose"),
};

/***********************
 * INIT
 ***********************/
function init() {
  // Ensure map image src matches config (optional)
  if (dom.mapImage && MAP_IMAGE_SRC) dom.mapImage.src = MAP_IMAGE_SRC;

  loadEntries();
  wireTabs();
  wireLog();
  wireModal();
  wireCalibration();
  wireMapPanZoom();

  if (dom.totalDistanceLabel) dom.totalDistanceLabel.textContent = `${TOTAL_DISTANCE.toLocaleString()}`;

  // Render after image loads so calibration math is correct
  if (dom.mapImage && dom.mapImage.complete && dom.mapImage.naturalWidth > 0) {
    renderAll();
    resetView();
  } else if (dom.mapImage) {
    dom.mapImage.addEventListener("load", () => {
      renderAll();
      resetView();
    });
  } else {
    renderAll();
  }
}

function renderAll() {
  renderRoutePaths();
  renderWaypoints();
  updateUI();
}

/***********************
 * STORAGE
 ***********************/
function loadEntries() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    const parsed = saved ? JSON.parse(saved) : [];
    entries = Array.isArray(parsed) ? parsed : [];
  } catch {
    entries = [];
  }
}

function saveEntries() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
}

/***********************
 * COMPUTED
 ***********************/
function totalWalked() {
  return entries.reduce((sum, e) => sum + (Number(e.distance) || 0), 0);
}

function pctComplete() {
  return Math.min(100, (totalWalked() / TOTAL_DISTANCE) * 100);
}

function kmRemaining() {
  return Math.max(0, TOTAL_DISTANCE - totalWalked());
}

function currentWaypointIndex() {
  const tw = totalWalked();
  const idx = WAYPOINTS.findIndex(w => w.distance > tw);
  return idx === -1 ? WAYPOINTS.length - 1 : idx;
}

function getCurrentWaypoint() {
  return WAYPOINTS[currentWaypointIndex()] || WAYPOINTS[WAYPOINTS.length - 1];
}

function getPreviousWaypoint() {
  const idx = currentWaypointIndex();
  return idx > 0 ? WAYPOINTS[idx - 1] : WAYPOINTS[0];
}

function getNextWaypointDistance() {
  const tw = totalWalked();
  const idx = WAYPOINTS.findIndex(w => w.distance > tw);
  if (idx === -1) return 0;
  return Math.max(0, WAYPOINTS[idx].distance - tw);
}

/* Marker position interpolated between previous and current waypoint */
function getMarkerPosition() {
  const tw = totalWalked();
  const idx = WAYPOINTS.findIndex(w => w.distance > tw);

  if (idx === -1) {
    const last = WAYPOINTS[WAYPOINTS.length - 1];
    return { x: last.x, y: last.y };
  }

  const prev = idx > 0 ? WAYPOINTS[idx - 1] : WAYPOINTS[0];
  const cur = WAYPOINTS[idx];

  const segStart = prev.distance;
  const segEnd = cur.distance;

  const t = segEnd === segStart ? 0 : (tw - segStart) / (segEnd - segStart);
  const clamped = Math.max(0, Math.min(1, t));

  return {
    x: prev.x + (cur.x - prev.x) * clamped,
    y: prev.y + (cur.y - prev.y) * clamped,
  };
}

/***********************
 * ROUTE RENDER (paths, not points)
 ***********************/
function routeD() {
  if (!WAYPOINTS.length) return "";
  const first = WAYPOINTS[0];
  let d = `M ${first.x} ${first.y}`;
  for (let i = 1; i < WAYPOINTS.length; i++) {
    d += ` L ${WAYPOINTS[i].x} ${WAYPOINTS[i].y}`;
  }
  return d;
}

/* We approximate total route length by polyline length in 0‚Äì100 space.
   This works well for stroke-dasharray effects, since it matches the viewBox. */
function polylineLength(points) {
  let len = 0;
  for (let i = 1; i < points.length; i++) {
    const dx = points[i].x - points[i - 1].x;
    const dy = points[i].y - points[i - 1].y;
    len += Math.sqrt(dx * dx + dy * dy);
  }
  return len;
}

function renderRoutePaths() {
  if (!dom.routeBase || !dom.routeCompleted) return;

  const d = routeD();
  dom.routeBase.setAttribute("d", d);
  dom.routeCompleted.setAttribute("d", d);

  // Completed route dash
  const totalLen = polylineLength(WAYPOINTS);
  const done = totalLen * (pctComplete() / 100);

  // show only "done" length
  dom.routeCompleted.style.strokeDasharray = `${done} ${totalLen}`;
}

/***********************
 * WAYPOINTS + MARKER
 ***********************/
function renderWaypoints() {
  if (!dom.waypointsGroup) return;

  dom.waypointsGroup.innerHTML = "";
  const tw = totalWalked();
  const idx = WAYPOINTS.findIndex(w => w.distance > tw); // current "next" waypoint index

  WAYPOINTS.forEach((w, i) => {
    const reached = tw >= w.distance;
    const current = i === idx;

    const g = svgEl("g", {
      class: `waypoint wp-hit ${current ? "wp-current" : (reached ? "wp-reached" : "wp-unreached")}`
    });

    // Outer
    g.appendChild(svgEl("circle", {
      class: "wp-outer",
      cx: w.x,
      cy: w.y,
    }));

    // Inner
    g.appendChild(svgEl("circle", {
      class: "wp-inner",
      cx: w.x,
      cy: w.y,
    }));

    // Click -> modal
    g.addEventListener("click", (e) => {
      e.stopPropagation();
      openWaypointModal(w);
    });

    dom.waypointsGroup.appendChild(g);
  });

  renderMarker();
}

function renderMarker() {
  if (!dom.markerRing || !dom.markerOuter || !dom.markerInner || !dom.markerEmoji) return;

  const { x, y } = getMarkerPosition();

  // sizes come from your CSS vars; we set positions and let CSS do sizing
  dom.markerRing.setAttribute("cx", x);
  dom.markerRing.setAttribute("cy", y);
  dom.markerRing.setAttribute("r", getCssNumber("--marker-ring-r", 0.95));

  dom.markerOuter.setAttribute("cx", x);
  dom.markerOuter.setAttribute("cy", y);
  dom.markerOuter.setAttribute("r", getCssNumber("--marker-outer-r", 0.55));
  dom.markerOuter.setAttribute("stroke-width", 0.18);

  dom.markerInner.setAttribute("cx", x);
  dom.markerInner.setAttribute("cy", y);
  dom.markerInner.setAttribute("r", getCssNumber("--marker-inner-r", 0.25));

  dom.markerEmoji.setAttribute("x", x);
  dom.markerEmoji.setAttribute("y", y + (getCssNumber("--marker-emoji-size", 1.3) * 0.35));
  dom.markerEmoji.setAttribute("font-size", getCssNumber("--marker-emoji-size", 1.3));
}

/***********************
 * UI UPDATES
 ***********************/
function updateUI() {
  const tw = totalWalked();
  const pct = pctComplete();
  const rem = kmRemaining();
  const cur = getCurrentWaypoint();

  if (dom.kmWalked) dom.kmWalked.textContent = tw.toFixed(1);
  if (dom.pctComplete) dom.pctComplete.textContent = `${pct.toFixed(1)}%`;
  if (dom.kmRemaining) dom.kmRemaining.textContent = rem.toFixed(0);
  if (dom.progressFill) dom.progressFill.style.width = `${pct}%`;

  if (dom.currentWaypointName) dom.currentWaypointName.textContent = cur.name;
  if (dom.currentWaypointDesc) dom.currentWaypointDesc.textContent = cur.description;

  const nextIn = getNextWaypointDistance();
  if (dom.nextKm) dom.nextKm.textContent = nextIn.toFixed(1);

  // terrain pill
  const t = TERRAIN_SUGGESTIONS[cur.terrain] || TERRAIN_SUGGESTIONS.flat;
  if (dom.terrainPill) {
    const emojiSpan = dom.terrainPill.querySelector(".emoji");
    if (emojiSpan) emojiSpan.textContent = t.icon;

    // update label text inside pill
    const textSpans = dom.terrainPill.querySelectorAll("span");
    if (textSpans.length >= 2) textSpans[1].textContent = t.activity;
  }
  if (dom.terrainTip) dom.terrainTip.textContent = `üí° ${t.tip}`;

  // Recent list
  renderRecent();

  // Stats
  const sNow = currentStreak(entries);
  const sBest = longestStreak(entries);
  const avg7 = sevenDayAverage(entries);
  const pace = userPace(entries);
  const paceVs = pace > 0 ? Math.round((pace / FRODO_DAILY_PACE) * 100) : 0;

  if (dom.statCurrentStreak) dom.statCurrentStreak.textContent = String(sNow);
  if (dom.statLongestStreak) dom.statLongestStreak.textContent = String(sBest);
  if (dom.statAvg7) dom.statAvg7.textContent = avg7.toFixed(1);

  if (dom.statPaceVs) dom.statPaceVs.textContent = `${paceVs}%`;
  if (dom.statPaceVsHint) dom.statPaceVsHint.textContent = pace > 0 ? "vs Frodo" : "Start walking";

  if (dom.statUserPace) dom.statUserPace.textContent = `${pace.toFixed(1)} km/day`;
  if (dom.statDaysSince) {
    const days = daysCovered(entries);
    dom.statDaysSince.textContent = `Based on ${days} day${days === 1 ? "" : "s"}`;
  }
  if (dom.statFrodoPace) dom.statFrodoPace.textContent = `${FRODO_DAILY_PACE.toFixed(1)} km/day`;

  if (dom.paceNote) {
    dom.paceNote.textContent =
      pace <= 0
        ? "üéØ Start your first walk to begin comparing your pace to Frodo‚Äôs journey."
        : pace > FRODO_DAILY_PACE
          ? "You‚Äôre walking faster than Frodo‚Äôs book pace."
          : "You‚Äôre taking a more relaxed pace than Frodo‚Äôs book pace.";
  }
}

function renderRecent() {
  if (!dom.recentCard || !dom.recentList) return;

  const sorted = entries.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
  const recent = sorted.slice(0, 10);

  if (recent.length === 0) {
    dom.recentCard.style.display = "none";
    dom.recentList.innerHTML = "";
    return;
  }

  dom.recentCard.style.display = "block";
  dom.recentList.innerHTML = "";

  recent.forEach(e => {
    const div = document.createElement("div");
    div.className = "entry";
    div.innerHTML = `
      <div>
        <div class="d">${escapeHtml(e.date)}</div>
        ${e.note ? `<div class="n">${escapeHtml(e.note)}</div>` : ""}
      </div>
      <div class="km">${Number(e.distance).toFixed(1)}</div>
    `;
    dom.recentList.appendChild(div);
  });
}

/***********************
 * TABS
 ***********************/
function wireTabs() {
  dom.tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-tab");
      setActiveTab(target);
    });
  });
}

function setActiveTab(name) {
  // Buttons
  dom.tabButtons.forEach(b => b.classList.toggle("active", b.getAttribute("data-tab") === name));

  // Sections
  if (dom.tabJourney) dom.tabJourney.classList.toggle("active", name === "journey");
  if (dom.tabStats) dom.tabStats.classList.toggle("active", name === "stats");
  if (dom.tabLog) dom.tabLog.classList.toggle("active", name === "log");
}

/***********************
 * LOG / CSV
 ***********************/
function wireLog() {
  if (dom.addEntryBtn) dom.addEntryBtn.addEventListener("click", addEntry);
  if (dom.exportBtn) dom.exportBtn.addEventListener("click", exportCSV);
  if (dom.resetBtn) dom.resetBtn.addEventListener("click", resetJourney);
  if (dom.csvInput) dom.csvInput.addEventListener("change", importCSV);
}

function addEntry() {
  const d = parseFloat(dom.distanceInput?.value || "");
  if (!Number.isFinite(d) || d <= 0) {
    alert("Please enter a valid distance.");
    return;
  }
  const note = (dom.noteInput?.value || "").trim();

  const entry = {
    id: Date.now(),
    date: new Date().toISOString().slice(0, 10),
    distance: d,
    note
  };

  entries.push(entry);
  // Keep chronological for streak functions
  entries.sort((a, b) => new Date(a.date) - new Date(b.date));

  saveEntries();

  if (dom.distanceInput) dom.distanceInput.value = "";
  if (dom.noteInput) dom.noteInput.value = "";

  renderAll();
}

function resetJourney() {
  const ok = confirm("‚ü≤ Reset Journey?\nThis deletes all entries and cannot be undone.");
  if (!ok) return;
  entries = [];
  saveEntries();
  renderAll();
}

function exportCSV() {
  if (!entries.length) {
    alert("No entries to export yet.");
    return;
  }

  const header = ["Date", "Distance (km)", "Note"];
  const lines = [header.join(",")];

  entries.forEach(e => {
    lines.push([
      e.date,
      Number(e.distance || 0),
      csvEscape(e.note || "")
    ].join(","));
  });

  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `one-walk-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importCSV(evt) {
  const file = evt.target.files?.[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const rows = parseCSV(String(reader.result || ""));
    if (!rows.length) return;

    // Expect header: Date, Distance (km), Note
    const data = rows.slice(1);
    const next = [];

    data.forEach(cols => {
      if (!cols || cols.length < 2) return;
      const date = (cols[0] || "").trim();
      const dist = parseFloat((cols[1] || "").trim());
      const note = (cols[2] || "").trim();

      if (!date || !Number.isFinite(dist) || dist <= 0) return;
      next.push({ id: Date.now() + Math.random(), date, distance: dist, note });
    });

    if (next.length) {
      entries = entries.concat(next);
      entries.sort((a, b) => new Date(a.date) - new Date(b.date));
      saveEntries();
      renderAll();
    }

    // allow re-importing same file
    evt.target.value = "";
  };
  reader.readAsText(file);
}

/***********************
 * MODAL
 ***********************/
function wireModal() {
  if (!dom.wpModalBackdrop || !dom.wpClose) return;

  dom.wpClose.addEventListener("click", closeWaypointModal);
  dom.wpModalBackdrop.addEventListener("click", (e) => {
    if (e.target === dom.wpModalBackdrop) closeWaypointModal();
  });
}

function openWaypointModal(w) {
  if (!dom.wpModalBackdrop) return;

  if (dom.wpTitle) dom.wpTitle.textContent = w.name;
  if (dom.wpDist) dom.wpDist.textContent = `${w.distance} km`;
  if (dom.wpTerrain) dom.wpTerrain.textContent = (TERRAIN_SUGGESTIONS[w.terrain]?.activity || w.terrain || "‚Äî");
  if (dom.wpLore) dom.wpLore.textContent = w.lore || "‚Äî";

  dom.wpModalBackdrop.classList.add("active");
}

function closeWaypointModal() {
  dom.wpModalBackdrop?.classList.remove("active");
}

/***********************
 * CALIBRATION MODE
 ***********************/
function wireCalibration() {
  if (!dom.calibrateBtn) return;

  dom.calibrateBtn.addEventListener("click", () => {
    calibrationMode = !calibrationMode;
    dom.calibrateBtn.textContent = `üéØ Calibration Mode: ${calibrationMode ? "ON" : "OFF"}`;
  });

  // Click on map to get coords
  if (dom.mapViewport) {
    dom.mapViewport.addEventListener("click", (e) => {
      if (!calibrationMode) return;

      // ignore clicks on controls
      if (e.target.closest(".map-controls") || e.target.closest(".tabs")) return;

      const coords = getPercentCoordsFromClick(e);
      alert(`Waypoint coords:\n  x: ${coords.x}\n  y: ${coords.y}\n\nPaste into your WAYPOINTS array.`);
      console.log("Calibration coords:", coords);
    });
  }
}

function getPercentCoordsFromClick(e) {
  if (!dom.mapImage) return { x: 0, y: 0 };

  const rect = dom.mapImage.getBoundingClientRect();
  const p = getClientPoint(e);

  const xNorm = (p.x - rect.left) / rect.width;
  const yNorm = (p.y - rect.top) / rect.height;

  const x = Math.max(0, Math.min(1, xNorm)) * 100;
  const y = Math.max(0, Math.min(1, yNorm)) * 100;

  return { x: +x.toFixed(2), y: +y.toFixed(2) };
}

/***********************
 * MAP PAN / ZOOM
 ***********************/
function wireMapPanZoom() {
  if (!dom.mapViewport || !dom.mapWrapper) return;

  // mouse
  dom.mapViewport.addEventListener("mousedown", onPanStart);
  window.addEventListener("mousemove", onPanMove);
  window.addEventListener("mouseup", onPanEnd);

  // touch (single finger pan)
  dom.mapViewport.addEventListener("touchstart", onPanStart, { passive: false });
  window.addEventListener("touchmove", onPanMove, { passive: false });
  window.addEventListener("touchend", onPanEnd);

  // zoom buttons
  dom.zoomIn?.addEventListener("click", () => zoomBy(1.2));
  dom.zoomOut?.addEventListener("click", () => zoomBy(1 / 1.2));
  dom.zoomReset?.addEventListener("click", () => resetView());

  // pinch zoom
  let lastPinchDist = 0;
  dom.mapViewport.addEventListener("touchstart", (e) => {
    if (e.touches.length === 2) lastPinchDist = touchDist(e.touches[0], e.touches[1]);
  }, { passive: false });

  dom.mapViewport.addEventListener("touchmove", (e) => {
    if (e.touches.length !== 2) return;
    e.preventDefault();
    const d = touchDist(e.touches[0], e.touches[1]);
    const delta = d - lastPinchDist;
    if (Math.abs(delta) > 1) {
      zoomBy(delta > 0 ? 1.04 : 0.96);
      lastPinchDist = d;
    }
  }, { passive: false });
}

function onPanStart(e) {
  // ignore when starting on SVG waypoint click targets
  if (e.target.closest("svg")) return;

  // ignore multi-touch (pinch)
  if (e.touches && e.touches.length > 1) return;

  isPanning = true;
  dom.mapViewport.classList.add("grabbing");

  const p = getClientPoint(e);
  panStartClientX = p.x;
  panStartClientY = p.y;
  panStartTranslateX = translateX;
  panStartTranslateY = translateY;
}

function onPanMove(e) {
  if (!isPanning) return;
  if (e.touches && e.touches.length > 1) return;

  e.preventDefault?.();

  const p = getClientPoint(e);
  translateX = panStartTranslateX + (p.x - panStartClientX);
  translateY = panStartTranslateY + (p.y - panStartClientY);
  applyTransform();
}

function onPanEnd() {
  if (!isPanning) return;
  isPanning = false;
  dom.mapViewport.classList.remove("grabbing");
}

function zoomBy(factor) {
  const next = clamp(scale * factor, 0.5, 5);
  scale = next;
  applyTransform();
}

function resetView() {
  scale = 1;
  centerOnWaypoint(WAYPOINTS[0]);
}

function centerOnWaypoint(wp) {
  if (!dom.mapImage || !dom.mapViewport) return;

  const viewport = dom.mapViewport.getBoundingClientRect();
  const imgRect = dom.mapImage.getBoundingClientRect();

  // We want coordinates in *image natural space*, not current rect; use natural dims.
  const imgW = dom.mapImage.naturalWidth || imgRect.width;
  const imgH = dom.mapImage.naturalHeight || imgRect.height;

  // target point in image pixels (natural)
  const targetX = (wp.x / 100) * imgW;
  const targetY = (wp.y / 100) * imgH;

  // Place target in center of viewport
  translateX = (viewport.width / 2) - targetX * scale;
  translateY = (viewport.height / 2) - targetY * scale;
  applyTransform();
}

function applyTransform() {
  if (!dom.mapWrapper) return;
  dom.mapWrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
}

/***********************
 * STATS HELPERS
 ***********************/
function daysCovered(arr) {
  if (!arr.length) return 0;
  const sorted = arr.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
  const start = new Date(sorted[0].date);
  const end = new Date(sorted[sorted.length - 1].date);
  start.setHours(0,0,0,0);
  end.setHours(0,0,0,0);
  return Math.max(1, Math.floor((end - start) / (1000*60*60*24)) + 1);
}

function userPace(arr) {
  if (!arr.length) return 0;
  const days = daysCovered(arr);
  return totalWalked() / days;
}

function sevenDayAverage(arr) {
  if (!arr.length) return 0;
  const sorted = arr.slice().sort((a,b) => new Date(a.date) - new Date(b.date));
  const last7 = sorted.slice(-7);
  const sum = last7.reduce((s, e) => s + (Number(e.distance) || 0), 0);
  return sum / last7.length;
}

function longestStreak(arr) {
  if (!arr.length) return 0;
  const sorted = arr.slice().sort((a,b) => new Date(a.date) - new Date(b.date));
  let best = 1;
  let cur = 1;

  for (let i = 1; i < sorted.length; i++) {
    const a = new Date(sorted[i-1].date); a.setHours(0,0,0,0);
    const b = new Date(sorted[i].date);   b.setHours(0,0,0,0);
    const diff = Math.floor((b - a) / (1000*60*60*24));
    if (diff === 1) {
      cur += 1;
      best = Math.max(best, cur);
    } else if (diff > 1) {
      cur = 1;
    }
  }
  return best;
}

function currentStreak(arr) {
  if (!arr.length) return 0;

  // count unique days (avoid double-counting multiple walks on same day)
  const byDate = new Map();
  arr.forEach(e => byDate.set(e.date, true));
  const dates = Array.from(byDate.keys()).sort((a,b) => new Date(b) - new Date(a));

  const today = new Date(); today.setHours(0,0,0,0);
  let streak = 0;

  let expected = new Date(today);
  for (const ds of dates) {
    const d = new Date(ds); d.setHours(0,0,0,0);
    const diff = Math.floor((expected - d) / (1000*60*60*24));

    // allow streak to include today OR yesterday as the start
    if (streak === 0 && (diff === 0 || diff === 1)) {
      streak += 1;
      expected = new Date(d);
      expected.setDate(expected.getDate() - 1);
      continue;
    }

    if (diff === 0) {
      // same expected day
      streak += 1;
      expected.setDate(expected.getDate() - 1);
      continue;
    }

    break;
  }

  return streak;
}

/***********************
 * UTILS
 ***********************/
function svgEl(tag, attrs = {}, text = null) {
  const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
  for (const [k, v] of Object.entries(attrs)) el.setAttribute(k, String(v));
  if (text !== null) el.textContent = text;
  return el;
}

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, s => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
  }[s]));
}

function csvEscape(s) {
  const t = String(s);
  return /[,"\n]/.test(t) ? `"${t.replace(/"/g, '""')}"` : t;
}

// tiny CSV parser with quotes
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];

    if (ch === '"' && inQuotes && next === '"') {
      cur += '"';
      i++;
      continue;
    }
    if (ch === '"') {
      inQuotes = !inQuotes;
      continue;
    }
    if (ch === "," && !inQuotes) {
      row.push(cur); cur = "";
      continue;
    }
    if ((ch === "\n" || ch === "\r") && !inQuotes) {
      if (ch === "\r" && next === "\n") i++;
      row.push(cur);
      rows.push(row);
      row = [];
      cur = "";
      continue;
    }
    cur += ch;
  }

  if (cur.length || row.length) {
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}

function getClientPoint(e) {
  if (e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  return { x: e.clientX, y: e.clientY };
}

function touchDist(a, b) {
  const dx = a.clientX - b.clientX;
  const dy = a.clientY - b.clientY;
  return Math.sqrt(dx*dx + dy*dy);
}

function getCssNumber(varName, fallback) {
  const v = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : fallback;
}

/***********************
 * BOOT
 ***********************/
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}
</script>
